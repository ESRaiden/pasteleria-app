<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <style>
        /* --- ESTILOS GLOBALES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-size: 10.5pt;
            color: #333;
            margin: 0;
        }
        .page-break { page-break-before: always; }
        .paid-watermark { 
            position: fixed; 
            z-index: -1; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) rotate(-45deg); 
            font-size: 120px; 
            font-weight: bold; 
            color: rgba(40, 167, 69, 0.15); /* AUMENTADO: Opacidad a 0.15 para mejor visibilidad */
        }

        /* --- NUEVO CONTENEDOR DE P√ÅGINA --- */
        .page-container {
            position: relative;
            min-height: 98vh; /* Ayuda a que el contenedor ocupe la mayor parte de la p√°gina */
        }

        /* --- ENCABEZADO Y FOLIO --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 25px;
            padding-top: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .header-info { text-align: left; }
        .logo { font-size: 24px; font-weight: bold; color: #d9534f; margin-bottom: 5px; }
        .header-date { font-size: 12pt; font-weight: bold; }
        .header-time { font-size: 11pt; color: #666; }

        .folio-box {
            border-radius: 8px;
            padding: 10px 15px;
            text-align: right;
            min-width: 150px;
        }
        .folio-label {
            font-size: 12pt;
            font-weight: bold;
            text-transform: uppercase;
            opacity: 0.85;
        }
        .folio-number {
            font-size: 28px;
            font-weight: 900;
            line-height: 1;
        }

        /* --- CONTENEDOR DE SECCIONES --- */
        .sections-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 0 25px;
            padding-bottom: 60px; /* Espacio extra en la parte inferior para el pie de p√°gina */
        }
        .main-column { width: 65%; }
        .side-column { width: 35%; }

        .section {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 11pt;
            font-weight: bold;
            color: #d9534f;
            text-transform: uppercase;
            margin-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 5px;
        }
        .data-item { margin-bottom: 6px; line-height: 1.4; }
        .data-label { font-weight: bold; color: #495057; }
        
        .account-item { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .account-total { font-weight: bold; border-top: 1px solid #dee2e6; padding-top: 5px; margin-top: 5px; }
        .account-balance { font-size: 1.1em; }

        /* --- FOOTER MODIFICADO --- */
        .footer {
            position: absolute;
            bottom: 25px; /* Distancia desde el borde inferior */
            left: 25px;
            right: 25px;
            text-align: center;
            font-size: 9.5pt;
            color: #888;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        /* --- P√ÅGINA 2 --- */
        .table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        .table th, .table td { border: 1px solid #dee2e6; padding: 6px; text-align: left; }
        .table th { background-color: #f8f9fa; }
        .image-container { text-align: center; margin-bottom: 15px; }
        .image-container img { max-width: 90%; max-height: 38vh; object-fit: contain; border: 1px solid #dee2e6; border-radius: 4px; }
        
        /* --- INICIO: NUEVOS ESTILOS PARA TARJETAS DE ALERTA --- */

        /* Estilo base para ambas tarjetas */
        .card-alert {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            border: 1px solid #ddd;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            overflow: hidden;
            background-color: transparent;
        }
        .card-alert-header {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .card-alert-header .icon {
            font-size: 1.8em;
            margin-right: 12px;
            line-height: 1;
        }
        .detail-item-alert {
            margin-bottom: 15px;
        }
        .detail-item-alert:last-child {
            margin-bottom: 0;
        }
        .detail-label-alert {
            font-size: 0.9em;
            font-weight: bold;
            color: #4B5563;
            display: block;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .detail-value-alert {
            font-size: 1.2em;
            font-weight: bold;
            color: #111827;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            background-color: transparent; /* CAMBIO CLAVE: Fondo transparente */
        }
        
        /* Estilo para las listas dentro de detail-value-alert (para adicionales) */
        .detail-value-alert ul {
            margin: 0;
            padding-left: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .detail-value-alert ul li {
            margin-bottom: 4px;
        }
        .detail-value-alert ul li:last-child {
            margin-bottom: 0;
        }

        /* Tarjeta Creativa (Naranja/Amarillo) */
        .card-creative {
            border-color: #FDE68A;
            border-left: 6px solid #F97316;
        }
        .card-creative .card-alert-header {
            color: #9A3412;
        }
        /* Eliminamos el background-color espec√≠fico para .detail-value-alert en esta tarjeta */
        /* .card-creative .detail-value-alert {
            background-color: #FEF3C7;
        } */

        /* Tarjeta de Complementos (Azul) */
        .card-addons {
            border-color: #BFDBFE;
            border-left: 6px solid #3B82F6;
        }
        .card-addons .card-alert-header {
            color: #1E40AF;
        }
        /* Eliminamos el background-color espec√≠fico para .detail-value-alert en esta tarjeta */
        /* .card-addons .detail-value-alert {
            background-color: #DBEAFE;
        } */

        /* --- FIN: NUEVOS ESTILOS --- */
    </style>
</head>
<body>
    <div class="page-container">
        <% if (folio.isPaid) { %><div class="paid-watermark">PAGADO</div><% } %>

        <div class="header">
            <div class="header-info">
                <div class="logo">Pasteler√≠a La Fiesta</div>
                <div class="header-date"><%= folio.formattedDeliveryDate %></div>
                <div class="header-time">Hora: <%= folio.formattedDeliveryTime %></div>
            </div>
            <div class="folio-box" style="background-color: <%= folio.dayColor %>;">
                <div class="folio-label" style="color: <%= folio.textColor %>;">Folio</div>
                <div class="folio-number" style="color: <%= folio.textColor %>;"><%= folio.folioNumber %></div>
            </div>
        </div>

        <div class="sections-wrapper">
            <div class="main-column">
                <div class="section">
                    <div class="section-title">Detalles del Pedido</div>
                    <div class="data-item"><span class="data-label">Personas:</span> <%= folio.persons %></div>
                    <div class="data-item"><span class="data-label">Forma:</span> <%= folio.shape %></div>
                    <% if (folio.folioType === 'Normal' || (folio.folioType === 'Base/Especial' && !folio.tiers)) { %>
                        <div class="data-item"><span class="data-label">Sabor(es):</span> <%= folio.cakeFlavor || 'N/A' %></div>
                        <div class="data-item"><span class="data-label">Relleno(s):</span> <%= folio.filling || 'N/A' %></div>
                    <% } %>
                    <% if (folio.hasExtraHeight) { %>
                        <div class="data-item"><span class="data-label">Altura:</span> S√≠, lleva altura extra.</div>
                    <% } %>
                </div>

                <% if (folio.designDescription || (folio.dedication && folio.dedication !== 'N/A')) { %>
                <div class="card-alert card-creative">
                    <div class="card-alert-header">
                        <span class="icon">üé®</span>
                        <span>¬°ATENCI√ìN! DETALLES CREATIVOS</span>
                    </div>
                    <% if (folio.designDescription) { %>
                    <div class="detail-item-alert">
                        <label class="detail-label-alert">Decorado:</label>
                        <div class="detail-value-alert"><%= folio.designDescription %></div>
                    </div>
                    <% } %>
                    <% if (folio.dedication && folio.dedication !== 'N/A') { %>
                    <div class="detail-item-alert">
                        <label class="detail-label-alert">Dedicatoria:</label>
                        <div class="detail-value-alert"><%= folio.dedication %></div>
                    </div>
                    <% } %>
                </div>
                <% } %>
                <% if (folio.complementFlavor) { %>
                <div class="section">
                    <div class="section-title">Pastel Complementario</div>
                    <div class="data-item"><span class="data-label">Personas:</span> <%= folio.complementPersons %></div>
                    <div class="data-item"><span class="data-label">Sabor(es):</span> <%= folio.complementFlavor %></div>
                    <div class="data-item"><span class="data-label">Relleno(s):</span> <%= folio.complementFilling || 'N/A' %></div>
                    <div class="data-item"><span class="data-label">Descripci√≥n:</span> <%= folio.complementDescription || 'N/A' %></div>
                </div>
                <% } %>
                
                <% 
                const hasAdditionals = folio.additional && Array.isArray(folio.additional) && folio.additional.length > 0;
                const hasAccessories = folio.accessories && folio.accessories !== 'N/A';
                if (hasAdditionals || hasAccessories) { 
                %>
                <div class="card-alert card-addons">
                    <div class="card-alert-header">
                        <span class="icon">üß©</span>
                        <span>¬°REVISAR! COMPLEMENTOS F√çSICOS</span>
                    </div>
                    <% if (hasAdditionals) { %>
                    <div class="detail-item-alert">
                        <label class="detail-label-alert">Adicionales:</label>
                        <div class="detail-value-alert">
                            <ul>
                                <% folio.additional.forEach(function(item) { %>
                                    <li><%= item.name %> ($<%= parseFloat(item.price).toFixed(2) %>)</li>
                                <% }); %>
                            </ul>
                        </div>
                    </div>
                    <% } %>
                    <% if (hasAccessories) { %>
                    <div class="detail-item-alert">
                        <label class="detail-label-alert">Accesorios:</label>
                        <div class="detail-value-alert"><%= folio.accessories %></div>
                    </div>
                    <% } %>
                </div>
                <% } %>
                </div>

            <div class="side-column">
                <div class="section">
                    <div class="section-title">Cliente</div>
                    <div class="data-item"><span class="data-label">Nombre:</span> <%= folio.client.name %></div>
                    <div class="data-item"><span class="data-label">Tel√©fono:</span> <%= folio.client.phone %></div>
                    <div class="data-item"><span class="data-label">Entrega:</span> <%= folio.deliveryLocation %></div>
                </div>
                <div class="section">
                    <div class="section-title">Cuenta</div>
                    <% let additionalCost = (folio.additional && Array.isArray(folio.additional)) ? folio.additional.reduce((sum, item) => sum + parseFloat(item.price || 0), 0) : 0; %>
                    <% let mainCakeCost = parseFloat(folio.total) - parseFloat(folio.deliveryCost) - additionalCost; %>
                    
                    <div class="account-item"><span class="data-label">Pastel(es):</span> <span>$<%= mainCakeCost.toFixed(2) %></span></div>
                    <% if (additionalCost > 0) { %><div class="account-item"><span class="data-label">Adicionales:</span> <span>$<%= additionalCost.toFixed(2) %></span></div><% } %>
                    <div class="account-item"><span class="data-label">Env√≠o:</span> <span>$<%= parseFloat(folio.deliveryCost).toFixed(2) %></span></div>
                    <div class="account-item account-total"><span class="data-label">Total:</span> <span>$<%= parseFloat(folio.total).toFixed(2) %></span></div>
                    <div class="account-item"><span class="data-label">Anticipo:</span> <span>$<%= parseFloat(folio.advancePayment).toFixed(2) %></span></div>
                    <div class="account-item account-total account-balance"><span class="data-label">Resta:</span> <span>$<%= parseFloat(folio.balance).toFixed(2) %></span></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Pedido capturado por: <%= folio.responsibleUser.username %> el <%= new Date(folio.createdAt).toLocaleString('es-MX') %>
        </div>
    </div>

    <% 
    const hasTiers = (folio.folioType === 'Base/Especial' && folio.tiers && Array.isArray(folio.tiers) && folio.tiers.length > 0);
    const hasImages = (folio.imageUrls && folio.imageUrls.length > 0);
    if (hasTiers || hasImages) { 
    %>
    <div class="page-break"></div>
    <div>
        <% if (hasTiers) { %>
        <div class="section">
            <div class="section-title">Estructura por Pisos</div>
            <table class="table">
                <thead><tr><th>Personas</th><th>Panes</th><th>Rellenos</th><th>Notas/Forma</th></tr></thead>
                <tbody>
                    <% folio.tiers.forEach(function(tier) { %>
                    <tr><td><%= tier.persons %></td><td><%= tier.panes %></td><td><%= tier.rellenos %></td><td><%= tier.notas %></td></tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>

        <% if (hasImages) { %>
        <div class="section" style="margin-top: 20px;">
            <div class="section-title">Im√°genes de Referencia</div>
            <% folio.imageUrls.forEach(function(imageData) { %>
                <div class="image-container">
                    <img src="http://localhost:3000/<%= imageData.url.replace(/\\/g, '/') %>">
                    <% if (imageData.comment) { %>
                        <p style="text-align: center; margin-top: 5px; font-size: 10pt;"><%= imageData.comment %></p>
                    <% } %>
                </div>
            <% }); %>
        </div>
        <% } %>
    </div>
    <% } %>
</body>
</html>