<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Folios - Pastelería La Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <style>
        .fc .fc-button-primary { background-color: #d9534f; border-color: #d9534f; }
        .fc .fc-button-primary:hover { background-color: #c9302c; border-color: #c9302c; }
        .fc .fc-daygrid-day.fc-day-today { background-color: #fcf8e3; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .hidden { display: none !important; }
        input:read-only, input:disabled { background-color: #e9ecef; cursor: not-allowed; }
        .image-preview-wrapper { position: relative; }
        .delete-image-btn {
            position: absolute; top: -8px; right: -8px;
            background-color: #dc3545; color: white;
            border-radius: 50%; width: 24px; height: 24px;
            border: 2px solid white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading" class="hidden"><p class="text-xl font-semibold">Cargando...</p></div>

    <div id="loginView">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <h1 class="text-3xl font-bold text-center text-red-500 mb-6">Pastelería "La fiesta"</h1>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-bold mb-2">Correo Electrónico</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 font-bold mb-2">Contraseña</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full">Iniciar Sesión</button>
                </form>
                <p id="loginError" class="text-red-500 text-center mt-4"></p>
            </div>
        </div>
    </div>

    <div id="appView" class="hidden">
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-2xl font-bold text-red-500">Pastelería "La fiesta"</h1>
                    <div>
                        <button id="logoutButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                        <button id="newFolioButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg ml-4">+ Nuevo Folio</button>
                    </div>
                </div>
            </div>
        </nav>

        <main id="calendarView" class="p-4 md:p-8">
            <div class="bg-white p-6 rounded-lg shadow-lg"><div id='calendar'></div></div>
        </main>

        <main id="formView" class="p-4 md:p-8 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-4xl mx-auto">
                <h2 id="formTitle" class="text-2xl font-bold mb-6 text-gray-800">Crear Nuevo Folio</h2>
                <form id="folioForm">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">Datos del Cliente</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="clientName" class="block mb-2 text-sm font-medium">Nombre del Cliente</label><input type="text" id="clientName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="clientPhone" class="block mb-2 text-sm font-medium">Teléfono del Cliente</label><input type="tel" id="clientPhone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    </div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">Detalles del Pedido Principal</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="deliveryDate" class="block mb-2 text-sm font-medium">Fecha de Entrega</label><input type="date" id="deliveryDate" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div>
                            <label class="block mb-2 text-sm font-medium">Hora de Entrega</label>
                            <div class="flex items-center gap-2">
                                <select id="deliveryHour" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></select>
                                <span class="font-bold">:</span>
                                <select id="deliveryMinute" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"><option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select>
                                <select id="deliveryPeriod" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"><option value="AM">AM</option><option value="PM">PM</option></select>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div>
                             <label for="folioType" class="block mb-2 text-sm font-medium">Tipo de Folio</label>
                            <select id="folioType" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                                <option value="Normal">Normal</option><option value="Base/Especial">Base/Especial</option>
                            </select>
                        </div>
                        <div><label for="persons" class="block mb-2 text-sm font-medium">Número de Personas</label><input type="number" id="persons" step="5" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="shape" class="block mb-2 text-sm font-medium">Forma del Pastel</label><input type="text" id="shape" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    </div>
                    
                    <div id="normalFields">
                        <div class="space-y-6">
                            <div><label for="cakeFlavor" class="block mb-2 text-sm font-medium">Sabor(es) del Pan</label><input type="text" id="cakeFlavor" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="filling" class="block mb-2 text-sm font-medium">Relleno(s) (Opcional)</label><input type="text" id="filling" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        </div>
                    </div>

                    <div id="specialFields" class="hidden mt-6">
                        <h4 class="text-md font-semibold mb-2 text-gray-600">Estructura por Pisos</h4>
                        <table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-4 py-3">Personas</th><th scope="col" class="px-4 py-3">Panes</th><th scope="col" class="px-4 py-3">Rellenos</th><th scope="col" class="px-4 py-3">Notas/Forma</th><th scope="col" class="px-1 py-3"></th></tr></thead><tbody id="tiersTableBody"></tbody></table>
                        <button type="button" id="addTierButton" class="mt-2 text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-4 py-2">+ Añadir Piso</button>
                    </div>

                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Pastel Complementario</h3>
                    <div class="flex items-center mb-4"><input id="addComplement" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"><label for="addComplement" class="ml-2 text-sm font-medium text-gray-900">Incluye pastel complementario</label></div>
                    <div id="complementForm" class="hidden space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div><label for="complementPersons" class="block mb-2 text-sm font-medium">Personas</label><input type="number" id="complementPersons" step="5" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="complementFlavor" class="block mb-2 text-sm font-medium">Sabor del Pan</label><input type="text" id="complementFlavor" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="complementFilling" class="block mb-2 text-sm font-medium">Relleno</label><input type="text" id="complementFilling" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        </div>
                        <div><label for="complementDescription" class="block mb-2 text-sm font-medium">Descripción (Complemento)</label><textarea id="complementDescription" rows="2" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300"></textarea></div>
                    </div>

                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Diseño y Adicionales</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium">Adicionales</label>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="text" id="additionalName" placeholder="Descripción (ej: Vela, Letrero)" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                                <input type="number" id="additionalPrice" placeholder="Precio" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-40 p-2.5">
                                <button type="button" id="addAdditionalButton" class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-4 py-2">+</button>
                            </div>
                            <ul id="additionalList" class="list-disc list-inside text-gray-700 ml-4"></ul>
                        </div>
                        <div><label for="accessories" class="block mb-2 text-sm font-medium">Accesorios (sin costo)</label><textarea id="accessories" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300"></textarea></div>
                        <div><label for="designDescription" class="block mb-2 text-sm font-medium">Descripción General del Diseño</label><textarea id="designDescription" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300" required></textarea></div>
                        <div><label for="dedication" class="block mb-2 text-sm font-medium">Dedicatoria (Opcional)</label><input type="text" id="dedication" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div>
                            <label for="referenceImages" class="block mb-2 text-sm font-medium">Imágenes de Referencia (hasta 5)</label>
                            <input type="file" id="referenceImages" name="referenceImages" multiple accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                            <div id="imagePreview" class="mt-4 flex flex-wrap gap-4"></div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Entrega</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="deliveryLocation" class="block mb-2 text-sm font-medium">Dirección de Entrega</label><input type="text" id="deliveryLocation" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div><label for="deliveryCost" class="block mb-2 text-sm font-medium">Costo de Envío</label><input type="number" id="deliveryCost" step="0.01" value="0" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                    </div>
                    <div class="flex items-center mb-6"><input id="inStorePickup" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"><label for="inStorePickup" class="ml-2 text-sm font-medium text-gray-900">Se recoge en tienda</label></div>
                    
                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Cuenta</h3>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div><label for="total" class="block mb-2 text-sm font-medium">Costo del Pastel (base)</label><input type="number" id="total" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="advancePayment" class="block mb-2 text-sm font-medium">Anticipo</label><input type="number" id="advancePayment" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="balance" class="block mb-2 text-sm font-medium text-gray-700">Resta (se calcula solo)</label><input type="text" id="balance" class="bg-gray-200 border border-gray-300 text-sm rounded-lg block w-full p-2.5" readonly></div>
                    </div>
                    <div class="flex items-center mb-6"><input id="isPaid" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"><label for="isPaid" class="ml-2 text-sm font-medium text-gray-900">Pedido Pagado en su Totalidad</label></div>
                    
                    <div class="flex items-center space-x-4"><button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5">Guardar Folio</button><button type="button" id="cancelFormButton" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-5 py-2.5">Cancelar</button></div>
                </form>
            </div>
        </main>
        
        <div id="folioModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
             <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-2xl leading-6 font-bold text-gray-900" id="modalFolioNumber"></h3>
                    <div class="mt-4 px-7 py-3 text-left space-y-2">
                        <p><strong>Cliente:</strong> <span id="modalClientName"></span></p><p><strong>Teléfono:</strong> <span id="modalClientPhone"></span></p><p><strong>Personas:</strong> <span id="modalPersons"></span></p><p><strong>Descripción:</strong> <span id="modalDescription"></span></p>
                    </div>
                    <div class="items-center px-4 py-3"><button id="closeModal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full">Cerrar</button></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Referencias a elementos del DOM ---
            const loginView = document.getElementById('loginView'), appView = document.getElementById('appView'), loginForm = document.getElementById('loginForm'), loginError = document.getElementById('loginError'), emailInput = document.getElementById('email'), passwordInput = document.getElementById('password'), logoutButton = document.getElementById('logoutButton'), calendarView = document.getElementById('calendarView'), formView = document.getElementById('formView'), newFolioButton = document.getElementById('newFolioButton'), cancelFormButton = document.getElementById('cancelFormButton'), folioForm = document.getElementById('folioForm'), calendarEl = document.getElementById('calendar'), modal = document.getElementById('folioModal'), closeModalBtn = document.getElementById('closeModal'), loadingEl = document.getElementById('loading'), inStorePickupCheckbox = document.getElementById('inStorePickup'), deliveryLocationInput = document.getElementById('deliveryLocation'), deliveryCostInput = document.getElementById('deliveryCost'), totalInput = document.getElementById('total'), advanceInput = document.getElementById('advancePayment'), balanceInput = document.getElementById('balance'), imageInput = document.getElementById('referenceImages'), imagePreview = document.getElementById('imagePreview'), folioTypeSelect = document.getElementById('folioType'), normalFields = document.getElementById('normalFields'), specialFields = document.getElementById('specialFields'), tiersTableBody = document.getElementById('tiersTableBody'), addTierButton = document.getElementById('addTierButton'), addComplementCheckbox = document.getElementById('addComplement'), complementForm = document.getElementById('complementForm'), isPaidCheckbox = document.getElementById('isPaid'), addAdditionalButton = document.getElementById('addAdditionalButton'), additionalList = document.getElementById('additionalList');
            let calendar;
            let selectedFiles = [];
            let additionalItems = [];

            // --- Lógica para poblar el selector de hora ---
            const hourSelect = document.getElementById('deliveryHour');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option'); option.value = i; option.textContent = i.toString().padStart(2, '0'); hourSelect.appendChild(option);
            }

            // --- Función de Fetch con Timeout ---
            async function fetchWithTimeout(resource, options = {}, timeout = 8000) { const controller = new AbortController(); const id = setTimeout(() => controller.abort(), timeout); const response = await fetch(resource, { ...options, signal: controller.signal }); clearTimeout(id); return response; }

            // --- Lógica de Calendario ---
            function initializeCalendar(authToken) {
                if (calendar) calendar.destroy();
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', locale: 'es', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                    events: function(fetchInfo, successCallback, failureCallback) {
                        loadingEl.classList.remove('hidden');
                        fetchWithTimeout('http://localhost:3000/api/folios', { method: 'GET', headers: { 'Authorization': `Bearer ${authToken}` }})
                        .then(response => { if (response.status === 401) { handleLogout(); throw new Error('Token no válido o sesión expirada.'); } if (!response.ok) { throw new Error(`Error del servidor: ${response.status}`); } return response.json(); })
                        .then(data => { const events = data.map(folio => ({ title: `Folio ${folio.folioNumber} - ${(folio.client ? folio.client.name : 'N/A')}`, start: `${folio.deliveryDate}T${folio.deliveryTime}`, extendedProps: { folioData: folio } })); successCallback(events); })
                        .catch(error => { failureCallback(error); if (error.name === 'AbortError' || error.message.includes('Token no válido')) handleLogout(); })
                        .finally(() => { loadingEl.classList.add('hidden'); });
                    },
                    eventClick: function(info) {
                        const folio = info.event.extendedProps.folioData;
                        document.getElementById('modalFolioNumber').innerText = `Folio: ${folio.folioNumber}`;
                        document.getElementById('modalClientName').innerText = folio.client ? folio.client.name : 'N/A';
                        document.getElementById('modalClientPhone').innerText = folio.client ? folio.client.phone : 'N/A';
                        document.getElementById('modalPersons').innerText = folio.persons;
                        document.getElementById('modalDescription').innerText = folio.designDescription;
                        modal.classList.remove('hidden');
                    }
                });
                calendar.render();
            }

            // --- Lógica de Vistas y Sesión ---
            function showView(viewToShow) { calendarView.classList.add('hidden'); formView.classList.add('hidden'); if (viewToShow === 'calendar') calendarView.classList.remove('hidden'); else if (viewToShow === 'form') formView.classList.remove('hidden'); }
            function showAppView(token) { loginView.classList.add('hidden'); appView.classList.remove('hidden'); initializeCalendar(token); }
            function handleLogout() { localStorage.removeItem('authToken'); appView.classList.add('hidden'); loginView.classList.remove('hidden'); if (calendar) calendar.destroy(); alert("Sesión cerrada."); }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault(); loadingEl.classList.remove('hidden'); loginError.textContent = '';
                fetchWithTimeout('http://localhost:3000/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: emailInput.value, password: passwordInput.value }) })
                .then(response => response.json()).then(data => { if (data.token) { localStorage.setItem('authToken', data.token); showAppView(data.token); } else { throw new Error(data.message || 'Error al iniciar sesión.'); } })
                .catch(error => { loginError.textContent = 'Error: ' + error.message; }).finally(() => { loadingEl.classList.add('hidden'); });
            });

            newFolioButton.addEventListener('click', () => {
                folioForm.reset(); selectedFiles = []; renderImagePreviews(); additionalItems = []; renderAdditionalItems(); balanceInput.value = '0.00'; inStorePickupCheckbox.checked = false; addComplementCheckbox.checked = false;
                deliveryLocationInput.readOnly = false; deliveryLocationInput.value = '';
                deliveryCostInput.readOnly = false; deliveryCostInput.value = '0';
                complementForm.classList.add('hidden');
                document.getElementById('formTitle').textContent = 'Crear Nuevo Folio';
                folioTypeSelect.dispatchEvent(new Event('change'));
                showView('form');
            });
            
            cancelFormButton.addEventListener('click', () => { showView('calendar'); });

            folioForm.addEventListener('submit', async (e) => {
                e.preventDefault(); loadingEl.classList.remove('hidden');
                const authToken = localStorage.getItem('authToken');
                const formData = new FormData();
                let hour = parseInt(document.getElementById('deliveryHour').value);
                const minute = document.getElementById('deliveryMinute').value, period = document.getElementById('deliveryPeriod').value;
                if (period === 'PM' && hour !== 12) { hour += 12; } if (period === 'AM' && hour === 12) { hour = 0; }
                const deliveryTime = `${hour.toString().padStart(2, '0')}:${minute}:00`;

                formData.append('clientName', document.getElementById('clientName').value);
                formData.append('clientPhone', document.getElementById('clientPhone').value);
                formData.append('deliveryDate', document.getElementById('deliveryDate').value);
                formData.append('deliveryTime', deliveryTime);
                formData.append('folioType', folioTypeSelect.value);
                formData.append('persons', document.getElementById('persons').value);
                formData.append('shape', document.getElementById('shape').value);
                formData.append('designDescription', document.getElementById('designDescription').value);
                formData.append('dedication', document.getElementById('dedication').value);
                formData.append('deliveryLocation', document.getElementById('deliveryLocation').value);
                formData.append('deliveryCost', document.getElementById('deliveryCost').value);
                formData.append('total', document.getElementById('total').value);
                formData.append('advancePayment', document.getElementById('advancePayment').value);
                formData.append('accessories', document.getElementById('accessories').value);
                formData.append('additional', JSON.stringify(additionalItems));
                formData.append('isPaid', isPaidCheckbox.checked);

                if (folioTypeSelect.value === 'Base/Especial') {
                    const tiers = [];
                    document.querySelectorAll('.tier-row').forEach(row => {
                        const inputs = row.querySelectorAll('input');
                        tiers.push({ persons: inputs[0].value, panes: inputs[1].value, rellenos: inputs[2].value, notas: inputs[3].value, });
                    });
                    formData.append('tiers', JSON.stringify(tiers));
                } else {
                    formData.append('cakeFlavor', document.getElementById('cakeFlavor').value);
                    formData.append('filling', document.getElementById('filling').value);
                }
                
                if (addComplementCheckbox.checked) {
                    formData.append('complementPersons', document.getElementById('complementPersons').value);
                    formData.append('complementFlavor', document.getElementById('complementFlavor').value);
                    formData.append('complementFilling', document.getElementById('complementFilling').value);
                    formData.append('complementDescription', document.getElementById('complementDescription').value);
                }

                for (const file of selectedFiles) { formData.append('referenceImages', file); }

                try {
                    const response = await fetchWithTimeout('http://localhost:3000/api/folios', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: formData });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'Error del servidor'); }
                    alert('¡Folio creado con éxito!'); showView('calendar'); if(calendar) calendar.refetchEvents();
                } catch (error) { alert('Error al crear el folio: ' + error.message); } finally { loadingEl.classList.add('hidden'); }
            });
            
            inStorePickupCheckbox.addEventListener('change', function() { const isChecked = this.checked; deliveryLocationInput.value = isChecked ? 'Recoge en Tienda' : ''; deliveryLocationInput.readOnly = isChecked; deliveryCostInput.value = isChecked ? '0' : ''; deliveryCostInput.readOnly = isChecked; calculateBalance(); });
            
            function calculateBalance() { 
                const total = parseFloat(totalInput.value) || 0; 
                const advance = parseFloat(advanceInput.value) || 0; 
                const delivery = parseFloat(deliveryCostInput.value) || 0;
                const additional = additionalItems.reduce((sum, item) => sum + parseFloat(item.price || 0), 0);
                balanceInput.value = (total + delivery + additional - advance).toFixed(2); 
            }
            [totalInput, advanceInput, deliveryCostInput].forEach(input => input.addEventListener('input', calculateBalance));
            
            isPaidCheckbox.addEventListener('change', function() {
                const total = parseFloat(totalInput.value) || 0; const delivery = parseFloat(deliveryCostInput.value) || 0;
                const additional = additionalItems.reduce((sum, item) => sum + parseFloat(item.price || 0), 0);
                const grandTotal = total + delivery + additional;
                if (this.checked) { advanceInput.value = grandTotal.toFixed(2); advanceInput.readOnly = true; } 
                else { advanceInput.readOnly = false; }
                calculateBalance();
            });
            [totalInput, deliveryCostInput].forEach(input => { input.addEventListener('input', () => { if (isPaidCheckbox.checked) { const total = parseFloat(totalInput.value) || 0; const delivery = parseFloat(deliveryCostInput.value) || 0; const additional = additionalItems.reduce((sum, item) => sum + parseFloat(item.price || 0), 0); advanceInput.value = (total + delivery + additional).toFixed(2); } }); });

            function renderImagePreviews() {
                imagePreview.innerHTML = '';
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const wrapper = document.createElement('div'); wrapper.className = 'image-preview-wrapper';
                        wrapper.innerHTML = `<img src="${e.target.result}" class="h-24 w-24 object-cover rounded-md border"><button type="button" class="delete-image-btn" data-index="${index}">&times;</button>`;
                        imagePreview.appendChild(wrapper);
                    }
                    reader.readAsDataURL(file);
                });
            }
            imageInput.addEventListener('change', () => {
                if (imageInput.files.length + selectedFiles.length > 5) { alert('Solo puedes subir un máximo de 5 imágenes.'); imageInput.value = ''; return; }
                selectedFiles.push(...imageInput.files); renderImagePreviews(); imageInput.value = '';
            });
            imagePreview.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-image-btn')) { const indexToRemove = parseInt(e.target.dataset.index, 10); selectedFiles.splice(indexToRemove, 1); renderImagePreviews(); }
            });

            function renderAdditionalItems() {
                additionalList.innerHTML = '';
                additionalItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1';
                    li.innerHTML = `<span>${item.name} - $${parseFloat(item.price).toFixed(2)}</span><button type="button" class="remove-additional-btn text-red-500 font-bold px-2" data-index="${index}">X</button>`;
                    additionalList.appendChild(li);
                });
                calculateBalance();
            }
            addAdditionalButton.addEventListener('click', () => {
                const nameInput = document.getElementById('additionalName');
                const priceInput = document.getElementById('additionalPrice');
                if (nameInput.value && priceInput.value) {
                    additionalItems.push({ name: nameInput.value, price: priceInput.value });
                    renderAdditionalItems();
                    nameInput.value = ''; priceInput.value = '';
                } else { alert('Por favor, completa la descripción y el precio del adicional.'); }
            });
            additionalList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-additional-btn')) {
                    additionalItems.splice(e.target.dataset.index, 1);
                    renderAdditionalItems();
                }
            });

            function addTierRow() { const row = document.createElement('tr'); row.className = 'tier-row border-b'; row.innerHTML = `<td class="p-2"><input type="text" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Personas"></td><td class="p-2"><input type="text" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Panes"></td><td class="p-2"><input type="text" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Rellenos"></td><td class="p-2"><input type="text" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Notas"></td><td class="p-1"><button type="button" class="remove-tier-button text-red-500 font-bold px-2">X</button></td>`; tiersTableBody.appendChild(row); }
            folioTypeSelect.addEventListener('change', function() {
                const isSpecial = this.value === 'Base/Especial';
                normalFields.classList.toggle('hidden', isSpecial);
                specialFields.classList.toggle('hidden', !isSpecial);
                document.getElementById('cakeFlavor').required = !isSpecial;
                if (isSpecial && tiersTableBody.children.length === 0) { addTierRow(); addTierRow(); }
            });
            addTierButton.addEventListener('click', addTierRow);
            tiersTableBody.addEventListener('click', function(e) { if (e.target.classList.contains('remove-tier-button')) e.target.closest('tr').remove(); });
            addComplementCheckbox.addEventListener('change', function() { complementForm.classList.toggle('hidden', !this.checked); if (!this.checked) { complementForm.querySelectorAll('input, textarea').forEach(input => input.value = ''); } });
            
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            logoutButton.addEventListener('click', handleLogout);

            const storedToken = localStorage.getItem('authToken');
            if (storedToken) { showAppView(storedToken); }
        });
    </script>
</body>
</html>