<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Folios - Pastelería La Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100">

    <div id="loading" class="hidden"><p class="text-xl font-semibold">Cargando...</p></div>

    <div id="loginView">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <h1 class="text-3xl font-bold text-center text-red-500 mb-6">Pastelería "La fiesta"</h1>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-bold mb-2">Correo Electrónico</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 font-bold mb-2">Contraseña</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full">Iniciar Sesión</button>
                </form>
                <p id="loginError" class="text-red-500 text-center mt-4"></p>
            </div>
        </div>
    </div>

    <div id="appView" class="hidden">
        <nav class="bg-white shadow-md">
             <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-2xl font-bold text-red-500">Pastelería "La fiesta"</h1>
                    <div>
                        <button id="viewCalendarButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Ver Calendario</button>
                        <button id="newFolioButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg ml-4">+ Nuevo Folio</button>
                        <button id="logoutButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg ml-4">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </nav>

        <main id="formView" class="p-4 md:p-8 hidden">
             <div class="bg-white p-8 rounded-lg shadow-lg max-w-4xl mx-auto">
                <h2 id="formTitle" class="text-2xl font-bold mb-6 text-gray-800">Crear Nuevo Folio</h2>
                <form id="folioForm">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">Datos del Cliente</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="clientName" class="block mb-2 text-sm font-medium">Nombre del Cliente</label><input type="text" id="clientName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="clientPhone" class="block mb-2 text-sm font-medium">Teléfono del Cliente</label><input type="tel" id="clientPhone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    </div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">Detalles del Pedido Principal</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="deliveryDate" class="block mb-2 text-sm font-medium">Fecha de Entrega</label><input type="date" id="deliveryDate" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div>
                            <label class="block mb-2 text-sm font-medium">Hora de Entrega</label>
                            <div class="flex items-center gap-2">
                                <select id="deliveryHour" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></select>
                                <span class="font-bold">:</span>
                                <select id="deliveryMinute" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"><option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select>
                                <select id="deliveryPeriod" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"><option value="AM">AM</option><option value="PM">PM</option></select>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div>
                             <label for="folioType" class="block mb-2 text-sm font-medium">Tipo de Folio</label>
                            <select id="folioType" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                                <option value="Normal">Normal</option><option value="Base/Especial">Base/Especial</option>
                            </select>
                        </div>
                        <div><label for="persons" class="block mb-2 text-sm font-medium">Número de Personas (Total)</label><input type="number" id="persons" step="5" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div>
                            <label for="shape" class="block mb-2 text-sm font-medium">Forma del Pastel</label>
                            <input type="text" id="shape" list="shape-options" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                            <datalist id="shape-options">
                                <option value="Redondo"></option>
                                <option value="Rectangular"></option>
                                <option value="Corazon"></option>
                            </datalist>
                        </div>
                    </div>
                    
                    <div id="normalFields">
                        <div class="space-y-6">
                            <div>
                                <label class="block mb-2 text-sm font-medium">Sabor(es) del Pan (Máx. 2)</label>
                                <div id="cakeFlavorContainer" class="tag-container"></div>
                                <button type="button" id="addCakeFlavorBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Añadir Sabor</button>
                            </div>
                            <div id="fillingSection">
                                <label class="block mb-2 text-sm font-medium">Relleno(s) (Máx. 2)</label>
                                <div id="fillingContainer" class="tag-container"></div>
                                <button type="button" id="addFillingBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Añadir Relleno</button>
                            </div>
                        </div>
                    </div>

                    <div id="specialFields" class="hidden mt-6">
                        <h4 class="text-md font-semibold mb-2 text-gray-600">Estructura por Pisos</h4>
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Personas</th>
                                    <th scope="col" class="px-4 py-3">Panes (3)</th>
                                    <th scope="col" class="px-4 py-3">Rellenos (2)</th>
                                    <th scope="col" class="px-4 py-3">Notas/Forma</th>
                                    <th scope="col" class="px-1 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="tiersTableBody"></tbody>
                        </table>
                        <button type="button" id="addTierButton" class="mt-2 text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-4 py-2">+ Añadir Piso</button>
                    </div>

                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Pastel Complementario</h3>
                    <div class="flex items-center mb-4"><input id="addComplement" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"><label for="addComplement" class="ml-2 text-sm font-medium text-gray-900">Incluye pastel complementario</label></div>
                    <div id="complementForm" class="hidden space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div><label for="complementPersons" class="block mb-2 text-sm font-medium">Personas</label><input type="number" id="complementPersons" step="5" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="complementFlavor" class="block mb-2 text-sm font-medium">Sabor del Pan</label><input type="text" id="complementFlavor" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="complementFilling" class="block mb-2 text-sm font-medium">Relleno</label><input type="text" id="complementFilling" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        </div>
                        <div><label for="complementDescription" class="block mb-2 text-sm font-medium">Descripción (Complemento)</label><textarea id="complementDescription" rows="2" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300"></textarea></div>
                    </div>

                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Diseño y Adicionales</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium">Adicionales</label>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="text" id="additionalName" placeholder="Descripción (ej: Vela, Letrero)" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                                <input type="number" id="additionalQuantity" value="1" min="1" placeholder="Cant." class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-20 p-2.5">
                                <span class="text-gray-500 font-bold">x</span>
                                <input type="number" id="additionalPrice" placeholder="Precio Unitario" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-32 p-2.5">
                                <button type="button" id="addAdditionalButton" class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-5 py-2.5">+</button>
                            </div>
                            <ul id="additionalList" class="list-disc list-inside text-gray-700 ml-4"></ul>
                        </div>
                        <div><label for="accessories" class="block mb-2 text-sm font-medium">Accesorios</label><textarea id="accessories" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300"></textarea></div>
                        <div><label for="designDescription" class="block mb-2 text-sm font-medium">Descripción General del Diseño</label><textarea id="designDescription" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300" required></textarea></div>
                        
                        <div class="flex items-center">
                            <input id="hasExtraHeight" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded">
                            <label for="hasExtraHeight" class="ml-2 text-sm font-medium text-gray-900">¿El pastel lleva altura extra?</label>
                        </div>

                        <div><label for="dedication" class="block mb-2 text-sm font-medium">Dedicatoria (Opcional)</label><input type="text" id="dedication" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        <div>
                            <label for="referenceImages" class="block mb-2 text-sm font-medium">Imágenes de Referencia (hasta 5)</label>
                            <input type="file" id="referenceImages" name="referenceImages" multiple accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                            <div id="imagePreview" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Entrega</h3>
                     <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                           <label for="deliveryCost" class="block mb-2 text-sm font-medium">Costo de Envío</label>
                           <input type="number" id="deliveryCost" step="0.01" value="0" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                        </div>
                         <div class="flex items-center pt-5">
                            <input id="inStorePickup" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="inStorePickup" class="ml-2 text-sm font-medium text-gray-900">Se recoge en tienda</label>
                        </div>
                    </div>
                    <div id="deliveryAddressSection">
                        <div class="flex items-center mb-4">
                            <input id="googleMapsLocation" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="googleMapsLocation" class="ml-2 text-sm font-medium text-gray-900">El cliente envía ubicación (Google Maps)</label>
                        </div>
                        <div id="addressFields">
                            <div class="grid md:grid-cols-1 gap-6 mb-4">
                                <div><label for="neighborhood" class="block mb-2 text-sm font-medium">Colonia</label><input type="text" id="neighborhood" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            </div>
                            <div class="mb-4"><label for="street" class="block mb-2 text-sm font-medium">Calle</label><input type="text" id="street" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div class="grid md:grid-cols-2 gap-6 mb-4">
                                <div><label for="extNumber" class="block mb-2 text-sm font-medium">Número Exterior</label><input type="text" id="extNumber" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                                <div><label for="intNumber" class="block mb-2 text-sm font-medium">Número Interior (Opcional)</label><input type="text" id="intNumber" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Cuenta</h3>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div><label for="total" class="block mb-2 text-sm font-medium">Costo del Pastel (base)</label><input type="number" id="total" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="advancePayment" class="block mb-2 text-sm font-medium">Anticipo</label><input type="number" id="advancePayment" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="balance" class="block mb-2 text-sm font-medium text-gray-700">Resta (se calcula solo)</label><input type="text" id="balance" class="bg-gray-200 border border-gray-300 text-sm rounded-lg block w-full p-2.5" readonly></div>
                    </div>
                    <div class="flex items-center mb-6"><input id="isPaid" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"><label for="isPaid" class="ml-2 text-sm font-medium text-gray-900">Pedido Pagado en su Totalidad</label></div>
                    
                    <div class="flex items-center space-x-4"><button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5">Guardar Folio</button><button type="button" id="cancelFormButton" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-5 py-2.5">Cancelar</button></div>
                </form>
            </div>
        </main>

        <main id="calendarView" class="p-4 md:p-8 hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Calendario de Pedidos</h2>
                    <div class="relative w-1/3">
                        <input type="text" id="folioSearchInput" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" placeholder="Buscar por Folio o Teléfono..." autocomplete="off">
                        <div id="searchResults" class="absolute bg-white border rounded-b-lg mt-1 w-full z-10 hidden shadow-lg"></div>
                    </div>
                </div>
                <div id='calendar'></div>
            </div>
        </main>
        
        <div id="folioModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
             <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center border-b pb-3 mb-3">
                    <h3 class="text-2xl leading-6 font-bold text-gray-900" id="modalFolioNumber"></h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="modalContent" class="mt-2 text-left space-y-4"></div>
                <div class="items-center px-4 py-3 mt-4 border-t">
                    <button id="editFolioButton" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-auto hover:bg-blue-600">Editar Folio</button>
                     <button id="viewPdfButton" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto hover:bg-green-600 ml-2">Ver PDF</button>
                </div>
            </div>
        </div>

        <div id="dailyFoliosModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-xl leading-6 font-bold text-gray-900" id="dailyFoliosTitle">Folios del Día</h3>
                    <button id="closeDailyFoliosModal" class="text-black text-2xl font-bold">&times;</button>
                </div>
                <div id="dailyFoliosList" class="mt-4 px-2 py-3 space-y-2 max-h-96 overflow-y-auto">
                </div>
            </div>
        </div>
        <div id="selectionModal" class="modal-selection hidden">
            <div class="modal-content">
                <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
                <div id="modal-step-1">
                    <input type="text" id="modalSearch" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Buscar...">
                    <div id="modalList"></div>
                </div>
                <div id="modal-step-2" class="hidden">
                    <h4 id="modal-step-2-title" class="text-lg font-semibold mb-2"></h4>
                    <div id="modal-step-2-list"></div>
                </div>
                <button id="modalCloseBtn" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="main.js"></script>
    <script src="calendar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- INICIO DE LA CORRECCIÓN: Script completo ---
            const folioForm = document.getElementById('folioForm'), 
                  formTitle = document.getElementById('formTitle'),
                  clientNameInput = document.getElementById('clientName'), 
                  clientPhoneInput = document.getElementById('clientPhone'),
                  deliveryDateInput = document.getElementById('deliveryDate'), 
                  deliveryHourSelect = document.getElementById('deliveryHour'), 
                  deliveryMinuteSelect = document.getElementById('deliveryMinute'), 
                  deliveryPeriodSelect = document.getElementById('deliveryPeriod'), 
                  folioTypeSelect = document.getElementById('folioType'), 
                  personsInput = document.getElementById('persons'), 
                  shapeInput = document.getElementById('shape'), 
                  imageInput = document.getElementById('referenceImages'), 
                  imagePreview = document.getElementById('imagePreview'), 
                  totalInput = document.getElementById('total'), 
                  advanceInput = document.getElementById('advancePayment'), 
                  balanceInput = document.getElementById('balance'), 
                  isPaidCheckbox = document.getElementById('isPaid'), 
                  hasExtraHeightCheckbox = document.getElementById('hasExtraHeight'), 
                  addComplementCheckbox = document.getElementById('addComplement'), 
                  complementForm = document.getElementById('complementForm'), 
                  accessoriesInput = document.getElementById('accessories'), 
                  designDescriptionTextarea = document.getElementById('designDescription'), 
                  dedicationInput = document.getElementById('dedication'), 
                  deliveryCostInput = document.getElementById('deliveryCost'), 
                  inStorePickupCheckbox = document.getElementById('inStorePickup'), 
                  googleMapsLocationCheckbox = document.getElementById('googleMapsLocation'), 
                  streetInput = document.getElementById('street'), 
                  extNumberInput = document.getElementById('extNumber'), 
                  intNumberInput = document.getElementById('intNumber'), 
                  neighborhoodInput = document.getElementById('neighborhood'), 
                  addressFields = document.getElementById('addressFields'), 
                  newFolioButton = document.getElementById('newFolioButton'), 
                  cancelFormButton = document.getElementById('cancelFormButton'), 
                  addCakeFlavorBtn = document.getElementById('addCakeFlavorBtn'), 
                  addFillingBtn = document.getElementById('addFillingBtn'), 
                  cakeFlavorContainer = document.getElementById('cakeFlavorContainer'), 
                  fillingContainer = document.getElementById('fillingContainer'), 
                  fillingSection = document.getElementById('fillingSection'), 
                  selectionModal = document.getElementById('selectionModal'), 
                  modalTitle = document.getElementById('modalTitle'), 
                  modalSearch = document.getElementById('modalSearch'), 
                  modalList = document.getElementById('modalList'), 
                  modalCloseBtn = document.getElementById('modalCloseBtn'), 
                  modalStep1 = document.getElementById('modal-step-1'), 
                  modalStep2 = document.getElementById('modal-step-2'), 
                  modalStep2Title = document.getElementById('modal-step-2-title'), 
                  modalStep2List = document.getElementById('modal-step-2-list'), 
                  tiersTableBody = document.getElementById('tiersTableBody'), 
                  addTierButton = document.getElementById('addTierButton'), 
                  additionalList = document.getElementById('additionalList'), 
                  addAdditionalButton = document.getElementById('addAdditionalButton'), 
                  normalFields = document.getElementById('normalFields'), 
                  specialFields = document.getElementById('specialFields');

            let additionalItems = [];
            let selectedFiles = [];
            let existingImages = [];
            let selectedCakeFlavors = [];
            let selectedFillings = [];
            let tiersData = [];
            let currentTierIndex = -1;
            
            const cakeFlavorsData = {
                normal: ['Pastel de queso', 'Pan de tres leches', 'Chocolate', 'Red Velvet', 'Mil Hojas', 'Zanahoria', 'Queso/Flan', 'Mantequilla'],
                tier: ['Mantequilla', 'Queso', 'Nata', 'Chocolate', 'Vainilla', 'Flan', 'Red Velvet']
            };
            const fillingsData = {
                'incluidos': { 'Mermelada': ['Zarzamora', 'Fresa', 'Piña', 'Durazno'], 'Manjar': ['Nuez', 'Coco', 'Almendra'], 'Dulce de Leche': ['Envinada', 'Nuez', 'Almendra', 'Coco'], 'Duraznos': ['Crema de Yogurth', 'Chantilly', 'Rompope'], 'Nuez': ['Manjar', 'Mocka', 'Capuchino'] },
                'conCosto': { 'Cajeta': ['Nuez', 'Coco', 'Almendra', 'Oreo'], 'Crema de Queso': ['Mermelada zarzamora', 'Mermelada fresa', 'Cajeta', 'Envinada'], 'Oreo': ['Manjar', 'Crema de yogurth fresa', 'Crema de chocolate', 'Chantilly'], 'Cremas': ['Mocka', 'Yogurth de fresa', 'Café con o sin brandy'], 'Chantilly con fresas': [], 'Nutella': [], 'Cocktail de frutas': ['Chantilly', 'Crema de queso', 'Crema de Yogurth'], 'Crema de queso con Chocoretas': [], 'Snickers / Milky Way': ['Manjar', 'Chantilly', 'Crema de yogurth fresa', 'Crema de chocolate'] }
            };

            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option'); option.value = i; option.textContent = i.toString().padStart(2, '0');
                deliveryHourSelect.appendChild(option);
            }

            function resetForm() {
                folioForm.reset();
                formTitle.textContent = 'Crear Nuevo Folio';
                delete folioForm.dataset.editingId;
                additionalItems = [];
                selectedFiles = [];
                existingImages = [];
                selectedCakeFlavors = [];
                selectedFillings = [];
                tiersData = [];
                additionalList.innerHTML = '';
                imagePreview.innerHTML = '';
                renderTags(cakeFlavorContainer, [], null);
                renderTags(fillingContainer, [], null);
                tiersTableBody.innerHTML = '';
                inStorePickupCheckbox.dispatchEvent(new Event('change'));
                addComplementCheckbox.dispatchEvent(new Event('change'));
                folioTypeSelect.dispatchEvent(new Event('change'));
                updateTotals();
            }

            window.populateFormForEdit = (folio) => {
                resetForm();
                formTitle.textContent = `Editando Folio: ${folio.folioNumber}`;
                folioForm.dataset.editingId = folio.id;

                clientNameInput.value = folio.client.name;
                clientPhoneInput.value = folio.client.phone;
                deliveryDateInput.value = folio.deliveryDate;
                personsInput.value = folio.persons;
                shapeInput.value = folio.shape;
                designDescriptionTextarea.value = folio.designDescription;
                dedicationInput.value = folio.dedication || '';
                accessoriesInput.value = folio.accessories || '';
                deliveryCostInput.value = parseFloat(folio.deliveryCost);

                const [hour, minute] = folio.deliveryTime.split(':');
                const hour12 = (parseInt(hour) % 12) || 12;
                deliveryHourSelect.value = hour12;
                deliveryMinuteSelect.value = minute;
                deliveryPeriodSelect.value = parseInt(hour) >= 12 ? 'PM' : 'AM';
                
                isPaidCheckbox.checked = folio.isPaid;
                hasExtraHeightCheckbox.checked = folio.hasExtraHeight;
                
                if (folio.additional && folio.additional.length > 0) {
                    additionalItems = folio.additional.map(item => {
                        const match = item.name.match(/(\d+)\s*x\s*(.*)/);
                        if (match) {
                            const quantity = parseInt(match[1]);
                            const name = match[2];
                            const price = parseFloat(item.price);
                            return { name, quantity, price: price / quantity, totalPrice: price };
                        }
                        return { name: item.name, quantity: 1, price: parseFloat(item.price), totalPrice: parseFloat(item.price) };
                    });
                    renderAdditionalItems();
                }

                if (folio.imageUrls && folio.imageUrls.length > 0) {
                    existingImages = folio.imageUrls.map((url, index) => ({
                        url: url,
                        comment: (folio.imageComments && folio.imageComments[index]) ? folio.imageComments[index] : ''
                    }));
                }
                
                renderImagePreviews();
                
                const additionalCost = (folio.additional || []).reduce((sum, item) => sum + parseFloat(item.price || 0), 0);
                const baseCakeCost = parseFloat(folio.total) - parseFloat(folio.deliveryCost) - additionalCost;
                totalInput.value = baseCakeCost.toFixed(2);
                advanceInput.value = parseFloat(folio.advancePayment).toFixed(2);
                
                updateTotals();
            };
            
            newFolioButton.addEventListener('click', resetForm);
            cancelFormButton.addEventListener('click', () => {
                resetForm();
                window.showMainView('calendar');
            });

            folioForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const editingId = folioForm.dataset.editingId;
                const isEditing = !!editingId;
                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `http://localhost:3000/api/folios/${editingId}` : 'http://localhost:3000/api/folios';
                
                document.getElementById('loading').classList.remove('hidden');
                const authToken = localStorage.getItem('authToken');
                const formData = new FormData();
                
                let hour = parseInt(deliveryHourSelect.value);
                if (deliveryPeriodSelect.value === 'PM' && hour !== 12) { hour += 12; }
                if (deliveryPeriodSelect.value === 'AM' && hour === 12) { hour = 0; }
                const deliveryTime = `${hour.toString().padStart(2, '0')}:${deliveryMinuteSelect.value}:00`;

                let deliveryLocation = '';
                if (inStorePickupCheckbox.checked) {
                    deliveryLocation = 'Recoge en Tienda';
                } else if (googleMapsLocationCheckbox.checked) {
                    deliveryLocation = 'El cliente envía ubicación (Google Maps)';
                } else {
                    deliveryLocation = [`${streetInput.value || ''} ${extNumberInput.value || ''}`.trim(), intNumberInput.value ? `Int. ${intNumberInput.value}` : '', neighborhoodInput.value ? `Col. ${neighborhoodInput.value}` : ''].filter(Boolean).join(', ');
                }

                formData.append('clientName', clientNameInput.value);
                formData.append('clientPhone', clientPhoneInput.value);
                formData.append('deliveryDate', deliveryDateInput.value);
                formData.append('deliveryTime', deliveryTime);
                formData.append('folioType', folioTypeSelect.value);
                formData.append('persons', personsInput.value);
                formData.append('shape', shapeInput.value);
                formData.append('designDescription', designDescriptionTextarea.value);
                formData.append('dedication', dedicationInput.value);
                formData.append('deliveryLocation', deliveryLocation);
                formData.append('deliveryCost', deliveryCostInput.value);
                formData.append('total', totalInput.value);
                formData.append('advancePayment', advanceInput.value);
                formData.append('accessories', accessoriesInput.value);
                
                const finalAdditionalItems = additionalItems.map(item => ({ name: `${item.quantity} x ${item.name}`, price: item.totalPrice }));
                formData.append('additional', JSON.stringify(finalAdditionalItems));
                
                formData.append('isPaid', isPaidCheckbox.checked);
                formData.append('hasExtraHeight', hasExtraHeightCheckbox.checked);
                
                if (isEditing) {
                    formData.append('existingImageUrls', JSON.stringify(existingImages.map(img => img.url)));
                    formData.append('existingImageComments', JSON.stringify(existingImages.map(img => img.comment)));
                }

                const newImageComments = selectedFiles.map(sf => sf.comment);
                formData.append('imageComments', JSON.stringify(newImageComments));

                for (const fileData of selectedFiles) {
                    formData.append('referenceImages', fileData.file);
                }
                
                try {
                    const response = await fetch(url, { method, headers: { 'Authorization': `Bearer ${authToken}` }, body: formData });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'Error del servidor'); }
                    
                    const successMessage = isEditing ? '¡Folio actualizado con éxito!' : '¡Folio creado con éxito!';
                    alert(successMessage);

                    const event = new CustomEvent('folioCreated');
                    window.dispatchEvent(event);

                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                }
            });

            function renderImagePreviews() {
                imagePreview.innerHTML = '';

                existingImages.forEach((imgData, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'image-preview-wrapper w-full';
                    wrapper.innerHTML = `
                        <img src="http://localhost:3000/${imgData.url.replace(/\\/g, '/')}" class="w-full h-auto object-cover rounded-md border">
                        <button type="button" class="delete-image-btn existing" data-index="${index}">&times;</button>
                        <textarea placeholder="Añadir un comentario..." class="w-full text-sm p-2 mt-2 border rounded existing-comment" data-index="${index}">${imgData.comment}</textarea>
                    `;
                    imagePreview.appendChild(wrapper);
                });

                selectedFiles.forEach((fileData, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'image-preview-wrapper w-full';
                    wrapper.innerHTML = `
                        <img src="${URL.createObjectURL(fileData.file)}" class="w-full h-auto object-cover rounded-md border">
                        <button type="button" class="delete-image-btn new" data-index="${index}">&times;</button>
                        <textarea placeholder="Añadir un comentario..." class="w-full text-sm p-2 mt-2 border rounded new-comment" data-index="${index}">${fileData.comment}</textarea>
                    `;
                    imagePreview.appendChild(wrapper);
                });
            }

            imageInput.addEventListener('change', () => {
                const files = Array.from(imageInput.files);
                if ((selectedFiles.length + existingImages.length + files.length) > 5) {
                    alert('Solo puedes subir un máximo de 5 imágenes en total.');
                    return;
                }
                selectedFiles.push(...files.map(file => ({ file, comment: '' })));
                renderImagePreviews();
                imageInput.value = '';
            });

            imagePreview.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-image-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (e.target.classList.contains('existing')) {
                        existingImages.splice(index, 1);
                    } else {
                        selectedFiles.splice(index, 1);
                    }
                    renderImagePreviews();
                }
            });

            imagePreview.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (e.target.classList.contains('existing-comment')) {
                        if (existingImages[index]) existingImages[index].comment = e.target.value;
                    } else {
                        if (selectedFiles[index]) selectedFiles[index].comment = e.target.value;
                    }
                }
            });

            function renderTags(container, tagsArray, onRemoveCallback) {
                container.innerHTML = '';
                tagsArray.forEach((tagData, index) => {
                    const tagEl = document.createElement('div');
                    tagEl.className = 'tag';
                    const tagName = typeof tagData === 'object' ? tagData.name : tagData;
                    tagEl.innerHTML = `<span>${tagName}</span><button type="button" class="tag-remove-btn" data-index="${index}">&times;</button>`;
                    container.appendChild(tagEl);
                });
                if (onRemoveCallback) {
                     container.querySelectorAll('.tag-remove-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => onRemoveCallback(parseInt(e.target.dataset.index, 10)));
                    });
                }
            }
            
            function openSelectionModal(title, data, currentTags, onSelectCallback, limit) {
                modalStep1.classList.remove('hidden');
                modalStep2.classList.add('hidden');
                modalTitle.textContent = title;
                modalSearch.value = '';
                
                function populateList(filter = '') {
                    modalList.innerHTML = '';
                    data.filter(item => item.toLowerCase().includes(filter.toLowerCase())).forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'modal-list-item';
                        itemEl.textContent = item;
                        itemEl.addEventListener('click', () => {
                            if (currentTags.length < limit) {
                                onSelectCallback(item);
                                selectionModal.classList.add('hidden');
                            } else {
                                alert(`Solo puedes seleccionar un máximo de ${limit}.`);
                            }
                        });
                        modalList.appendChild(itemEl);
                    });
                }
                populateList();
                modalSearch.onkeyup = () => populateList(modalSearch.value);
                selectionModal.classList.remove('hidden');
            }
            
            function openFillingModal(onSelectCallback, currentFillings, limit) {
                const showStep1 = () => {
                    modalTitle.textContent = 'Añadir Relleno (Paso 1 de 2)';
                    modalStep1.classList.remove('hidden');
                    modalStep2.classList.add('hidden');
                    modalSearch.value = '';
                    modalList.innerHTML = '';
                    [...Object.keys(fillingsData.incluidos).map(name => ({ name, hasCost: false })), ...Object.keys(fillingsData.conCosto).map(name => ({ name, hasCost: true }))].forEach(titular => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'modal-list-item';
                        if (titular.hasCost) itemEl.classList.add('cost-extra');
                        itemEl.textContent = titular.name;
                        itemEl.addEventListener('click', () => {
                            const complementos = (fillingsData.incluidos[titular.name] || fillingsData.conCosto[titular.name]);
                            if (complementos && complementos.length > 0) {
                                showStep2(titular, complementos);
                            } else {
                                if (currentFillings.length < limit) {
                                    onSelectCallback(titular);
                                    selectionModal.classList.add('hidden');
                                } else {
                                    alert(`Solo puedes seleccionar un máximo de ${limit} rellenos.`);
                                }
                            }
                        });
                        modalList.appendChild(itemEl);
                    });
                }
                const showStep2 = (titular, complementos) => {
                    modalStep1.classList.add('hidden');
                    modalStep2.classList.remove('hidden');
                    modalTitle.textContent = `Paso 2: Elige un complemento`;
                    modalStep2Title.innerHTML = `Complemento para "<b>${titular.name}</b>" <button type="button" class="back-to-step1 text-sm text-blue-600 hover:underline">(Volver)</button>`;
                    modalStep2List.innerHTML = '';
                    complementos.forEach(comp => {
                        const compEl = document.createElement('div');
                        compEl.className = 'modal-list-item';
                        compEl.textContent = comp;
                        compEl.addEventListener('click', () => {
                             if (currentFillings.length < limit) {
                                onSelectCallback({ name: `${titular.name} con ${comp}`, hasCost: titular.hasCost });
                                selectionModal.classList.add('hidden');
                            } else {
                                alert(`Solo puedes seleccionar un máximo de ${limit} rellenos.`);
                            }
                        });
                        modalStep2List.appendChild(compEl);
                    });
                    modalStep2Title.querySelector('.back-to-step1').addEventListener('click', showStep1);
                }
                showStep1();
                selectionModal.classList.remove('hidden');
            }

            modalCloseBtn.addEventListener('click', () => selectionModal.classList.add('hidden'));

            function addCakeFlavor(flavor) { if (selectedCakeFlavors.length < 2) { selectedCakeFlavors.push(flavor); renderTags(cakeFlavorContainer, selectedCakeFlavors, removeCakeFlavor); checkRestrictions(); } }
            function removeCakeFlavor(index) { selectedCakeFlavors.splice(index, 1); renderTags(cakeFlavorContainer, selectedCakeFlavors, removeCakeFlavor); checkRestrictions(); }
            function addFilling(filling) { if (selectedFillings.length < 2) { selectedFillings.push(filling); renderTags(fillingContainer, selectedFillings, removeFilling); updateTotals(); } }
            function removeFilling(index) { selectedFillings.splice(index, 1); renderTags(fillingContainer, selectedFillings, removeFilling); updateTotals(); }

            addCakeFlavorBtn.addEventListener('click', () => openSelectionModal('Sabor de Pan', cakeFlavorsData.normal, selectedCakeFlavors, addCakeFlavor, 2));
            addFillingBtn.addEventListener('click', () => openFillingModal(addFilling, selectedFillings, 2));

            function checkRestrictions() {
                const hasNoFillingPan = selectedCakeFlavors.includes('Pastel de queso') || selectedCakeFlavors.includes('Queso/Flan');
                const isMilHojas = selectedCakeFlavors.includes('Mil Hojas');
                fillingSection.classList.toggle('disabled-section', hasNoFillingPan || isMilHojas);
                designDescriptionTextarea.disabled = isMilHojas;
                if (hasNoFillingPan || isMilHojas) {
                    selectedFillings = [];
                    renderTags(fillingContainer, selectedFillings, removeFilling);
                    updateTotals();
                    if(isMilHojas) designDescriptionTextarea.value = "Mil Hojas no lleva diseño";
                }
            }
            
            inStorePickupCheckbox.addEventListener('change', function() { deliveryAddressSection.classList.toggle('hidden', this.checked); deliveryCostInput.readOnly = this.checked; if (this.checked) deliveryCostInput.value = '0'; updateTotals(); });
            googleMapsLocationCheckbox.addEventListener('change', function() { addressFields.classList.toggle('disabled-section', this.checked); });

            function getGrandTotal() {
                const total = parseFloat(totalInput.value) || 0;
                const delivery = parseFloat(deliveryCostInput.value) || 0;
                const additionalFromList = additionalItems.reduce((sum, item) => sum + item.totalPrice, 0);
                const persons = parseFloat(personsInput.value) || 0;
                const normalFillingCost = selectedFillings.reduce((sum, filling) => (filling.hasCost && persons > 0) ? sum + ((persons / 20) * 30) : sum, 0);
                const tierFillingCost = tiersData.reduce((sum, tier, index) => {
                    if (!tiersTableBody.children[index]) return sum;
                    const row = tiersTableBody.children[index];
                    const tierPersons = parseFloat(row.querySelector('.tier-persons-input').value) || 0;
                    return sum + tier.fillings.reduce((tierSum, filling) => (filling.hasCost && tierPersons > 0) ? tierSum + ((tierPersons / 20) * 30) : tierSum, 0);
                }, 0);
                return total + delivery + additionalFromList + normalFillingCost + tierFillingCost;
            }

            function calculateBalance() {
                balanceInput.value = (getGrandTotal() - (parseFloat(advanceInput.value) || 0)).toFixed(2);
            }

            function updateTotals() {
                if (isPaidCheckbox.checked) {
                    advanceInput.value = getGrandTotal().toFixed(2);
                }
                calculateBalance();
            }

            [totalInput, deliveryCostInput, personsInput].forEach(input => input.addEventListener('input', updateTotals));
            advanceInput.addEventListener('input', calculateBalance);
            isPaidCheckbox.addEventListener('change', function() {
                advanceInput.readOnly = this.checked;
                updateTotals();
            });
            tiersTableBody.addEventListener('input', (e) => {
                if (e.target.classList.contains('tier-persons-input')) updateTotals();
            });

            function renderAdditionalItems() {
                additionalList.innerHTML = '';
                additionalItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `${item.quantity} x ${item.name} - $${item.totalPrice.toFixed(2)} <button type="button" class="remove-additional-btn text-red-500 ml-2" data-index="${index}">[x]</button>`;
                    additionalList.appendChild(li);
                });
            }

            addAdditionalButton.addEventListener('click', () => {
                const nameInput = document.getElementById('additionalName'), quantityInput = document.getElementById('additionalQuantity'), priceInput = document.getElementById('additionalPrice');
                const name = nameInput.value.trim(), quantity = parseInt(quantityInput.value, 10), price = parseFloat(priceInput.value);
                if (name && quantity > 0 && !isNaN(price)) {
                    additionalItems.push({ name, quantity, price, totalPrice: quantity * price });
                    renderAdditionalItems();
                    updateTotals();
                    nameInput.value = '';
                    quantityInput.value = '1';
                    priceInput.value = '';
                } else {
                    alert('Por favor, completa la descripción, cantidad y precio del adicional.');
                }
            });

            additionalList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-additional-btn')) {
                    additionalItems.splice(e.target.dataset.index, 1);
                    renderAdditionalItems();
                    updateTotals();
                }
            });

            function addTierRow() {
                const index = tiersData.length;
                tiersData.push({ panes: [], fillings: [] });
                const row = document.createElement('tr');
                row.className = 'tier-row border-b';
                row.dataset.index = index;
                row.innerHTML = `<td class="p-2"><input type="number" class="tier-persons-input bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Personas"></td><td class="p-2"><div class="tag-container panes-container"></div><button type="button" class="add-tier-pane-btn mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Pan</button></td><td class="p-2"><div class="tag-container fillings-container"></div><button type="button" class="add-tier-filling-btn mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Relleno</button></td><td class="p-2"><input type="text" class="tier-notes-input bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Notas"></td><td class="p-1 text-center"><button type="button" class="remove-tier-button text-red-500 font-bold px-2 text-lg">X</button></td>`;
                tiersTableBody.appendChild(row);
            }

            folioTypeSelect.addEventListener('change', function() {
                const isSpecial = this.value === 'Base/Especial';
                normalFields.classList.toggle('hidden', isSpecial);
                specialFields.classList.toggle('hidden', !isSpecial);
                if (isSpecial && tiersTableBody.children.length === 0) addTierRow();
                if (isSpecial) {
                    selectedCakeFlavors = [];
                    selectedFillings = [];
                    renderTags(cakeFlavorContainer, [], null);
                    renderTags(fillingContainer, [], null);
                } else {
                    tiersData = [];
                    tiersTableBody.innerHTML = '';
                }
                updateTotals();
            });
            addTierButton.addEventListener('click', addTierRow);
            
            tiersTableBody.addEventListener('click', function(e) {
                const target = e.target;
                const row = target.closest('.tier-row');
                if (!row) return;

                currentTierIndex = parseInt(row.dataset.index, 10);

                const addTierPane = (flavor) => { if (tiersData[currentTierIndex].panes.length < 3) { tiersData[currentTierIndex].panes.push(flavor); renderTags(row.querySelector('.panes-container'), tiersData[currentTierIndex].panes, (tagIndex) => removeTierPane(currentTierIndex, tagIndex)); } };
                const removeTierPane = (tierIndex, tagIndex) => { tiersData[tierIndex].panes.splice(tagIndex, 1); renderTags(tiersTableBody.children[tierIndex].querySelector('.panes-container'), tiersData[tierIndex].panes, (tagIndex) => removeTierPane(tierIndex, tagIndex)); };
                const addTierFilling = (filling) => { if (tiersData[currentTierIndex].fillings.length < 2) { tiersData[currentTierIndex].fillings.push(filling); renderTags(row.querySelector('.fillings-container'), tiersData[currentTierIndex].fillings, (tagIndex) => removeTierFilling(currentTierIndex, tagIndex)); updateTotals(); } };
                const removeTierFilling = (tierIndex, tagIndex) => { tiersData[tierIndex].fillings.splice(tagIndex, 1); renderTags(tiersTableBody.children[tierIndex].querySelector('.fillings-container'), tiersData[currentTierIndex].fillings, (tagIndex) => removeTierFilling(tierIndex, tagIndex)); updateTotals(); };

                if (target.classList.contains('add-tier-pane-btn')) {
                    openSelectionModal('Sabor de Pan (Piso)', cakeFlavorsData.tier, tiersData[currentTierIndex].panes, addTierPane, 3);
                } else if (target.classList.contains('add-tier-filling-btn')) {
                    openFillingModal(addTierFilling, tiersData[currentTierIndex].fillings, 2);
                } else if (target.classList.contains('remove-tier-button')) {
                    tiersData.splice(parseInt(row.dataset.index, 10), 1);
                    row.remove();
                    Array.from(tiersTableBody.children).forEach((r, i) => r.dataset.index = i);
                    updateTotals();
                } else if(target.closest('.tag-remove-btn')) {
                    const tagContainer = target.closest('.tag-container');
                    const tagIndex = parseInt(target.closest('.tag-remove-btn').dataset.index, 10);
                    if (tagContainer.classList.contains('panes-container')) removeTierPane(currentTierIndex, tagIndex);
                    else if (tagContainer.classList.contains('fillings-container')) removeTierFilling(currentTierIndex, tagIndex);
                }
            });

            addComplementCheckbox.addEventListener('change', function() {
                complementForm.classList.toggle('hidden', !this.checked);
            });
        });
    </script>
</body>
</html>