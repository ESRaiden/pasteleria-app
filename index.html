<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Folios - Pastelería La Fiesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <style>
        .fc .fc-button-primary { background-color: #d9534f; border-color: #d9534f; }
        .fc .fc-button-primary:hover { background-color: #c9302c; border-color: #c9302c; }
        .fc .fc-daygrid-day.fc-day-today { background-color: #fcf8e3; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .hidden { display: none !important; }
        input:read-only, input:disabled, textarea:disabled { background-color: #e9ecef; cursor: not-allowed; }
        .image-preview-wrapper { position: relative; }
        .delete-image-btn {
            position: absolute; top: -8px; right: -8px;
            background-color: #dc3545; color: white;
            border-radius: 50%; width: 24px; height: 24px;
            border: 2px solid white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; line-height: 1;
        }
        /* --- ESTILOS PARA EL NUEVO SISTEMA DE ETIQUETAS --- */
        .tag-container {
            display: flex; flex-wrap: wrap; gap: 8px;
            padding: 8px; border: 1px solid #d1d5db; border-radius: 0.5rem;
            background-color: #f9fafb; min-height: 42px;
        }
        .tag {
            display: flex; align-items: center;
            background-color: #e5e7eb; color: #374151;
            padding: 4px 8px; border-radius: 9999px;
            font-size: 0.875rem; font-weight: 500;
        }
        .tag-remove-btn {
            margin-left: 8px; background: none; border: none;
            color: #9ca3af; font-weight: bold; cursor: pointer;
        }
        .tag-remove-btn:hover { color: #374151; }
        .disabled-section { opacity: 0.5; pointer-events: none; }

        /* Estilos para el Modal de Selección */
        .modal-selection {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 20px;
            border-radius: 8px; width: 90%; max-width: 500px;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-list-item {
            padding: 10px; border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .modal-list-item:hover { background-color: #f3f4f6; }
        .modal-list-item.cost-extra::after {
            content: '(Costo Adicional)';
            font-size: 0.8rem; color: #ef4444; margin-left: 8px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading" class="hidden"><p class="text-xl font-semibold">Cargando...</p></div>

    <div id="loginView">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <h1 class="text-3xl font-bold text-center text-red-500 mb-6">Pastelería "La fiesta"</h1>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-bold mb-2">Correo Electrónico</label>
                        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 font-bold mb-2">Contraseña</label>
                        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                    </div>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full">Iniciar Sesión</button>
                </form>
                <p id="loginError" class="text-red-500 text-center mt-4"></p>
            </div>
        </div>
    </div>

    <div id="appView" class="hidden">
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-2xl font-bold text-red-500">Pastelería "La fiesta"</h1>
                    <div>
                        <button id="logoutButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
                        <button id="newFolioButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg ml-4">+ Nuevo Folio</button>
                    </div>
                </div>
            </div>
        </nav>

        <main id="calendarView" class="p-4 md:p-8">
            <div class="bg-white p-6 rounded-lg shadow-lg"><div id='calendar'></div></div>
        </main>

        <main id="formView" class="p-4 md:p-8 hidden">
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-4xl mx-auto">
                <h2 id="formTitle" class="text-2xl font-bold mb-6 text-gray-800">Crear Nuevo Folio</h2>
                <form id="folioForm">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">Datos del Cliente</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="clientName" class="block mb-2 text-sm font-medium">Nombre del Cliente</label><input type="text" id="clientName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="clientPhone" class="block mb-2 text-sm font-medium">Teléfono del Cliente</label><input type="tel" id="clientPhone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                    </div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 border-b pb-2">Detalles del Pedido Principal</h3>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div><label for="deliveryDate" class="block mb-2 text-sm font-medium">Fecha de Entrega</label><input type="date" id="deliveryDate" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div>
                            <label class="block mb-2 text-sm font-medium">Hora de Entrega</label>
                            <div class="flex items-center gap-2">
                                <select id="deliveryHour" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></select>
                                <span class="font-bold">:</span>
                                <select id="deliveryMinute" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"><option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option></select>
                                <select id="deliveryPeriod" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"><option value="AM">AM</option><option value="PM">PM</option></select>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div>
                             <label for="folioType" class="block mb-2 text-sm font-medium">Tipo de Folio</label>
                            <select id="folioType" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                                <option value="Normal">Normal</option><option value="Base/Especial">Base/Especial</option>
                            </select>
                        </div>
                        <div><label for="persons" class="block mb-2 text-sm font-medium">Número de Personas (Total)</label><input type="number" id="persons" step="5" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div>
                            <label for="shape" class="block mb-2 text-sm font-medium">Forma del Pastel</label>
                            <input type="text" id="shape" list="shape-options" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required>
                            <datalist id="shape-options">
                                <option value="Redondo"></option>
                                <option value="Rectangular"></option>
                                <option value="Corazon"></option>
                            </datalist>
                        </div>
                    </div>
                    
                    <div id="normalFields">
                        <div class="space-y-6">
                            <div>
                                <label class="block mb-2 text-sm font-medium">Sabor(es) del Pan (Máx. 2)</label>
                                <div id="cakeFlavorContainer" class="tag-container"></div>
                                <button type="button" id="addCakeFlavorBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Añadir Sabor</button>
                            </div>
                            <div id="fillingSection">
                                <label class="block mb-2 text-sm font-medium">Relleno(s) (Máx. 2)</label>
                                <div id="fillingContainer" class="tag-container"></div>
                                <button type="button" id="addFillingBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Añadir Relleno</button>
                            </div>
                        </div>
                    </div>

                    <div id="specialFields" class="hidden mt-6">
                        <h4 class="text-md font-semibold mb-2 text-gray-600">Estructura por Pisos</h4>
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Personas</th>
                                    <th scope="col" class="px-4 py-3">Panes (3)</th>
                                    <th scope="col" class="px-4 py-3">Rellenos (2)</th>
                                    <th scope="col" class="px-4 py-3">Notas/Forma</th>
                                    <th scope="col" class="px-1 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="tiersTableBody"></tbody>
                        </table>
                        <button type="button" id="addTierButton" class="mt-2 text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-4 py-2">+ Añadir Piso</button>
                    </div>

                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Pastel Complementario</h3>
                    <div class="flex items-center mb-4"><input id="addComplement" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"><label for="addComplement" class="ml-2 text-sm font-medium text-gray-900">Incluye pastel complementario</label></div>
                    <div id="complementForm" class="hidden space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div><label for="complementPersons" class="block mb-2 text-sm font-medium">Personas</label><input type="number" id="complementPersons" step="5" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="complementFlavor" class="block mb-2 text-sm font-medium">Sabor del Pan</label><input type="text" id="complementFlavor" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div><label for="complementFilling" class="block mb-2 text-sm font-medium">Relleno</label><input type="text" id="complementFilling" class="bg-white border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                        </div>
                        <div><label for="complementDescription" class="block mb-2 text-sm font-medium">Descripción (Complemento)</label><textarea id="complementDescription" rows="2" class="block p-2.5 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300"></textarea></div>
                    </div>

                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Diseño y Adicionales</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium">Adicionales</label>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="text" id="additionalName" placeholder="Descripción (ej: Vela, Letrero)" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                                <input type="number" id="additionalQuantity" value="1" min="1" placeholder="Cant." class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-20 p-2.5">
                                <span class="text-gray-500 font-bold">x</span>
                                <input type="number" id="additionalPrice" placeholder="Precio Unitario" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-32 p-2.5">
                                <button type="button" id="addAdditionalButton" class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-5 py-2.5">+</button>
                            </div>
                            <ul id="additionalList" class="list-disc list-inside text-gray-700 ml-4"></ul>
                        </div>
                        
                        <div>
                            <label for="designDescription" class="block mb-2 text-sm font-medium">Descripción General del Diseño</label>
                            <textarea id="designDescription" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300" required></textarea>
                        </div>
                        
                        <div class="flex items-center">
                            <input id="hasExtraHeight" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded">
                            <label for="hasExtraHeight" class="ml-2 text-sm font-medium text-gray-900">¿El pastel lleva altura extra?</label>
                        </div>
                        
                        <div>
                            <label for="accessories" class="block mb-2 text-sm font-medium">Accesorios (sin costo)</label>
                            <textarea id="accessories" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300"></textarea>
                        </div>
                        <div>
                            <label for="dedication" class="block mb-2 text-sm font-medium">Dedicatoria (Opcional)</label>
                            <input type="text" id="dedication" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                        </div>
                        <div>
                            <label for="referenceImages" class="block mb-2 text-sm font-medium">Imágenes de Referencia (hasta 5)</label>
                            <input type="file" id="referenceImages" name="referenceImages" multiple accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
                            <div id="imagePreview" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Entrega</h3>
                     <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                           <label for="deliveryCost" class="block mb-2 text-sm font-medium">Costo de Envío</label>
                           <input type="number" id="deliveryCost" step="0.01" value="0" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5">
                        </div>
                         <div class="flex items-center pt-5">
                            <input id="inStorePickup" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="inStorePickup" class="ml-2 text-sm font-medium text-gray-900">Se recoge en tienda</label>
                        </div>
                    </div>
                    <div id="deliveryAddressSection">
                        <div class="flex items-center mb-4">
                            <input id="googleMapsLocation" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="googleMapsLocation" class="ml-2 text-sm font-medium text-gray-900">El cliente envía ubicación (Google Maps)</label>
                        </div>
                        <div id="addressFields">
                            <div class="grid md:grid-cols-1 gap-6 mb-4">
                                <div><label for="neighborhood" class="block mb-2 text-sm font-medium">Colonia</label><input type="text" id="neighborhood" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            </div>
                            <div class="mb-4"><label for="street" class="block mb-2 text-sm font-medium">Calle</label><input type="text" id="street" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            <div class="grid md:grid-cols-2 gap-6 mb-4">
                                <div><label for="extNumber" class="block mb-2 text-sm font-medium">Número Exterior</label><input type="text" id="extNumber" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                                <div><label for="intNumber" class="block mb-2 text-sm font-medium">Número Interior (Opcional)</label><input type="text" id="intNumber" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold my-6 text-gray-700 border-b pb-2">Cuenta</h3>
                    <div class="grid md:grid-cols-3 gap-6 mb-6">
                        <div><label for="total" class="block mb-2 text-sm font-medium">Costo del Pastel (base)</label><input type="number" id="total" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="advancePayment" class="block mb-2 text-sm font-medium">Anticipo</label><input type="number" id="advancePayment" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2.5" required></div>
                        <div><label for="balance" class="block mb-2 text-sm font-medium text-gray-700">Resta (se calcula solo)</label><input type="text" id="balance" class="bg-gray-200 border border-gray-300 text-sm rounded-lg block w-full p-2.5" readonly></div>
                    </div>
                    <div class="flex items-center mb-6"><input id="isPaid" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded"><label for="isPaid" class="ml-2 text-sm font-medium text-gray-900">Pedido Pagado en su Totalidad</label></div>
                    
                    <div class="flex items-center space-x-4"><button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5">Guardar Folio</button><button type="button" id="cancelFormButton" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 font-medium rounded-lg text-sm px-5 py-2.5">Cancelar</button></div>
                </form>
            </div>
        </main>
        
        <div id="folioModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
             <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-2xl leading-6 font-bold text-gray-900" id="modalFolioNumber"></h3>
                    <div class="mt-4 px-7 py-3 text-left space-y-2">
                        <p><strong>Cliente:</strong> <span id="modalClientName"></span></p><p><strong>Teléfono:</strong> <span id="modalClientPhone"></span></p><p><strong>Personas:</strong> <span id="modalPersons"></span></p><p><strong>Descripción:</strong> <span id="modalDescription"></span></p>
                    </div>
                    <div class="items-center px-4 py-3"><button id="closeModal" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full">Cerrar</button></div>
                </div>
            </div>
        </div>

        <div id="selectionModal" class="modal-selection hidden">
            <div class="modal-content">
                <h3 id="modalTitle" class="text-xl font-bold mb-4"></h3>
                <div id="modal-step-1">
                    <input type="text" id="modalSearch" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Buscar...">
                    <div id="modalList"></div>
                </div>
                <div id="modal-step-2" class="hidden">
                    <h4 id="modal-step-2-title" class="text-lg font-semibold mb-2"></h4>
                    <div id="modal-step-2-list"></div>
                </div>
                <button id="modalCloseBtn" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Referencias a elementos del DOM ---
            const loginView = document.getElementById('loginView'), appView = document.getElementById('appView'), loginForm = document.getElementById('loginForm'), loginError = document.getElementById('loginError'), emailInput = document.getElementById('email'), passwordInput = document.getElementById('password'), logoutButton = document.getElementById('logoutButton'), calendarView = document.getElementById('calendarView'), formView = document.getElementById('formView'), newFolioButton = document.getElementById('newFolioButton'), cancelFormButton = document.getElementById('cancelFormButton'), folioForm = document.getElementById('folioForm'), calendarEl = document.getElementById('calendar'), modal = document.getElementById('folioModal'), closeModalBtn = document.getElementById('closeModal'), loadingEl = document.getElementById('loading'), inStorePickupCheckbox = document.getElementById('inStorePickup'), deliveryCostInput = document.getElementById('deliveryCost'), totalInput = document.getElementById('total'), advanceInput = document.getElementById('advancePayment'), balanceInput = document.getElementById('balance'), imageInput = document.getElementById('referenceImages'), imagePreview = document.getElementById('imagePreview'), folioTypeSelect = document.getElementById('folioType'), normalFields = document.getElementById('normalFields'), specialFields = document.getElementById('specialFields'), tiersTableBody = document.getElementById('tiersTableBody'), addTierButton = document.getElementById('addTierButton'), addComplementCheckbox = document.getElementById('addComplement'), complementForm = document.getElementById('complementForm'), isPaidCheckbox = document.getElementById('isPaid'), addAdditionalButton = document.getElementById('addAdditionalButton'), additionalList = document.getElementById('additionalList'), personsInput = document.getElementById('persons'), designDescriptionTextarea = document.getElementById('designDescription'), hasExtraHeightCheckbox = document.getElementById('hasExtraHeight');
            
            // --- ELEMENTOS DE ENTREGA ---
            const deliveryAddressSection = document.getElementById('deliveryAddressSection');
            const googleMapsLocationCheckbox = document.getElementById('googleMapsLocation');
            const addressFields = document.getElementById('addressFields');
            const streetInput = document.getElementById('street');
            const extNumberInput = document.getElementById('extNumber');
            const intNumberInput = document.getElementById('intNumber');
            const neighborhoodInput = document.getElementById('neighborhood');

            // --- ELEMENTOS PARA ETIQUETAS ---
            const addCakeFlavorBtn = document.getElementById('addCakeFlavorBtn'), addFillingBtn = document.getElementById('addFillingBtn'), cakeFlavorContainer = document.getElementById('cakeFlavorContainer'), fillingContainer = document.getElementById('fillingContainer'), fillingSection = document.getElementById('fillingSection'), selectionModal = document.getElementById('selectionModal'), modalTitle = document.getElementById('modalTitle'), modalSearch = document.getElementById('modalSearch'), modalList = document.getElementById('modalList'), modalCloseBtn = document.getElementById('modalCloseBtn'), modalStep1 = document.getElementById('modal-step-1'), modalStep2 = document.getElementById('modal-step-2'), modalStep2Title = document.getElementById('modal-step-2-title'), modalStep2List = document.getElementById('modal-step-2-list');

            let calendar;
            let selectedFiles = [];
            let additionalItems = [];
            let selectedCakeFlavors = [];
            let selectedFillings = [];
            let tiersData = [];
            let currentTierIndex = -1; 
            
            // --- BASES DE DATOS DE SABORES Y RELLENOS ---
            const cakeFlavorsData = {
                normal: ['Pastel de queso', 'Pan de tres leches', 'Chocolate', 'Red Velvet', 'Mil Hojas', 'Zanahoria', 'Queso/Flan', 'Mantequilla'],
                tier: ['Mantequilla', 'Queso', 'Nata', 'Chocolate', 'Vainilla', 'Flan', 'Red Velvet']
            };
            const fillingsData = {
                'incluidos': {
                    'Mermelada': ['Zarzamora', 'Fresa', 'Piña', 'Durazno'],
                    'Manjar': ['Nuez', 'Coco', 'Almendra'],
                    'Dulce de Leche': ['Envinada', 'Nuez', 'Almendra', 'Coco'],
                    'Duraznos': ['Crema de Yogurth', 'Chantilly', 'Rompope'],
                    'Nuez': ['Manjar', 'Mocka', 'Capuchino']
                },
                'conCosto': {
                    'Cajeta': ['Nuez', 'Coco', 'Almendra', 'Oreo'],
                    'Crema de Queso': ['Mermelada zarzamora', 'Mermelada fresa', 'Cajeta', 'Envinada'],
                    'Oreo': ['Manjar', 'Crema de yogurth fresa', 'Crema de chocolate', 'Chantilly'],
                    'Cremas': ['Mocka', 'Yogurth de fresa', 'Café con o sin brandy'],
                    'Chantilly con fresas': [],
                    'Nutella': [],
                    'Cocktail de frutas': ['Chantilly', 'Crema de queso', 'Crema de Yogurth'],
                    'Crema de queso con Chocoretas': [],
                    'Snickers / Milky Way': ['Manjar', 'Chantilly', 'Crema de yogurth fresa', 'Crema de chocolate']
                }
            };

            // --- Lógica para poblar el selector de hora ---
            const hourSelect = document.getElementById('deliveryHour');
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option'); option.value = i; option.textContent = i.toString().padStart(2, '0'); hourSelect.appendChild(option);
            }

            // --- FUNCIÓN PARA RENDERIZAR ETIQUETAS ---
            function renderTags(container, tagsArray, onRemoveCallback) {
                container.innerHTML = '';
                tagsArray.forEach((tagData, index) => {
                    const tagEl = document.createElement('div');
                    tagEl.className = 'tag';
                    const tagName = typeof tagData === 'object' ? tagData.name : tagData;
                    tagEl.innerHTML = `
                        <span>${tagName}</span>
                        <button type="button" class="tag-remove-btn" data-index="${index}">&times;</button>
                    `;
                    container.appendChild(tagEl);
                });

                if (onRemoveCallback) {
                     container.querySelectorAll('.tag-remove-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const indexToRemove = parseInt(e.target.dataset.index, 10);
                            onRemoveCallback(indexToRemove);
                        });
                    });
                }
            }
            
            // --- LÓGICA DEL MODAL DE SELECCIÓN ---
            function openSelectionModal(title, data, currentTags, onSelectCallback, limit) {
                modalStep1.classList.remove('hidden');
                modalStep2.classList.add('hidden');
                modalTitle.textContent = title;
                modalSearch.value = '';
                
                function populateList(filter = '') {
                    modalList.innerHTML = '';
                    const filteredData = data.filter(item => item.toLowerCase().includes(filter.toLowerCase()));
                    
                    filteredData.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'modal-list-item';
                        itemEl.textContent = item;
                        itemEl.addEventListener('click', () => {
                            if (currentTags.length < limit) {
                                onSelectCallback(item);
                                selectionModal.classList.add('hidden');
                            } else {
                                alert(`Solo puedes seleccionar un máximo de ${limit}.`);
                            }
                        });
                        modalList.appendChild(itemEl);
                    });
                }

                populateList();
                modalSearch.onkeyup = () => populateList(modalSearch.value);
                selectionModal.classList.remove('hidden');
            }
            
            // --- LÓGICA ESPECÍFICA PARA RELLENOS (2 PASOS) ---
            function openFillingModal(onSelectCallback, currentFillings, limit) {
                const showStep1 = () => {
                    modalTitle.textContent = 'Añadir Relleno (Paso 1 de 2)';
                    modalStep1.classList.remove('hidden');
                    modalStep2.classList.add('hidden');
                    modalSearch.value = '';
                    modalList.innerHTML = '';

                    const allTitulares = [
                        ...Object.keys(fillingsData.incluidos).map(name => ({ name, hasCost: false })),
                        ...Object.keys(fillingsData.conCosto).map(name => ({ name, hasCost: true }))
                    ];

                    allTitulares.forEach(titular => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'modal-list-item';
                        if (titular.hasCost) itemEl.classList.add('cost-extra');
                        itemEl.textContent = titular.name;
                        itemEl.addEventListener('click', () => {
                            const complementos = (fillingsData.incluidos[titular.name] || fillingsData.conCosto[titular.name]);
                            if (complementos && complementos.length > 0) {
                                showStep2(titular, complementos);
                            } else {
                                if (currentFillings.length < limit) {
                                    onSelectCallback(titular);
                                    selectionModal.classList.add('hidden');
                                } else {
                                    alert(`Solo puedes seleccionar un máximo de ${limit} rellenos.`);
                                }
                            }
                        });
                        modalList.appendChild(itemEl);
                    });
                }

                const showStep2 = (titular, complementos) => {
                    modalStep1.classList.add('hidden');
                    modalStep2.classList.remove('hidden');
                    modalTitle.textContent = `Paso 2: Elige un complemento`;
                    modalStep2Title.innerHTML = `Complemento para "<b>${titular.name}</b>" <button type="button" class="back-to-step1 text-sm text-blue-600 hover:underline">(Volver)</button>`;
                    modalStep2List.innerHTML = '';
                    complementos.forEach(comp => {
                        const compEl = document.createElement('div');
                        compEl.className = 'modal-list-item';
                        compEl.textContent = comp;
                        compEl.addEventListener('click', () => {
                             if (currentFillings.length < limit) {
                                onSelectCallback({ name: `${titular.name} con ${comp}`, hasCost: titular.hasCost });
                                selectionModal.classList.add('hidden');
                            } else {
                                alert(`Solo puedes seleccionar un máximo de ${limit} rellenos.`);
                            }
                        });
                        modalStep2List.appendChild(compEl);
                    });
                    modalStep2Title.querySelector('.back-to-step1').addEventListener('click', showStep1);
                }
                
                showStep1();
                selectionModal.classList.remove('hidden');
            }

            modalCloseBtn.addEventListener('click', () => selectionModal.classList.add('hidden'));

            // --- FUNCIONES PARA SABORES Y RELLENOS (NORMAL) ---
            function addCakeFlavor(flavor) {
                if (selectedCakeFlavors.length < 2) {
                    selectedCakeFlavors.push(flavor);
                    renderTags(cakeFlavorContainer, selectedCakeFlavors, removeCakeFlavor);
                    checkRestrictions();
                }
            }
            function removeCakeFlavor(index) {
                selectedCakeFlavors.splice(index, 1);
                renderTags(cakeFlavorContainer, selectedCakeFlavors, removeCakeFlavor);
                checkRestrictions();
            }
            
            function addFilling(filling) {
                if (selectedFillings.length < 2) {
                    selectedFillings.push(filling);
                    renderTags(fillingContainer, selectedFillings, removeFilling);
                    updateTotals();
                }
            }
            function removeFilling(index) {
                selectedFillings.splice(index, 1);
                renderTags(fillingContainer, selectedFillings, removeFilling);
                updateTotals();
            }

            addCakeFlavorBtn.addEventListener('click', () => openSelectionModal('Sabor de Pan', cakeFlavorsData.normal, selectedCakeFlavors, addCakeFlavor, 2));
            addFillingBtn.addEventListener('click', () => openFillingModal(addFilling, selectedFillings, 2));

            // --- LÓGICA DE RESTRICCIONES (NORMAL) ---
            function checkRestrictions() {
                const hasNoFillingPan = selectedCakeFlavors.includes('Pastel de queso') || selectedCakeFlavors.includes('Queso/Flan');
                const isMilHojas = selectedCakeFlavors.includes('Mil Hojas');
                
                fillingSection.classList.toggle('disabled-section', hasNoFillingPan || isMilHojas);
                designDescriptionTextarea.disabled = isMilHojas;

                if (hasNoFillingPan || isMilHojas) {
                    selectedFillings = [];
                    renderTags(fillingContainer, selectedFillings, removeFilling);
                    updateTotals();
                    if(isMilHojas) designDescriptionTextarea.value = "Mil Hojas no lleva diseño";
                }
            }
            
            // --- Función de Fetch con Timeout ---
            async function fetchWithTimeout(resource, options = {}, timeout = 8000) { const controller = new AbortController(); const id = setTimeout(() => controller.abort(), timeout); const response = await fetch(resource, { ...options, signal: controller.signal }); clearTimeout(id); return response; }

            // --- Lógica de Calendario ---
            function initializeCalendar(authToken) {
                if (calendar) calendar.destroy();
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', locale: 'es', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                    events: function(fetchInfo, successCallback, failureCallback) {
                        loadingEl.classList.remove('hidden');
                        fetchWithTimeout('http://localhost:3000/api/folios', { method: 'GET', headers: { 'Authorization': `Bearer ${authToken}` }})
                        .then(response => { if (response.status === 401) { handleLogout(); throw new Error('Token no válido o sesión expirada.'); } if (!response.ok) { throw new Error(`Error del servidor: ${response.status}`); } return response.json(); })
                        .then(data => { const events = data.map(folio => ({ title: `Folio ${folio.folioNumber} - ${(folio.client ? folio.client.name : 'N/A')}`, start: `${folio.deliveryDate}T${folio.deliveryTime}`, extendedProps: { folioData: folio } })); successCallback(events); })
                        .catch(error => { failureCallback(error); if (error.name === 'AbortError' || error.message.includes('Token no válido')) handleLogout(); })
                        .finally(() => { loadingEl.classList.add('hidden'); });
                    },
                    eventClick: function(info) {
                        const folio = info.event.extendedProps.folioData;
                        document.getElementById('modalFolioNumber').innerText = `Folio: ${folio.folioNumber}`;
                        document.getElementById('modalClientName').innerText = folio.client ? folio.client.name : 'N/A';
                        document.getElementById('modalClientPhone').innerText = folio.client ? folio.client.phone : 'N/A';
                        document.getElementById('modalPersons').innerText = folio.persons;
                        document.getElementById('modalDescription').innerText = folio.designDescription;
                        modal.classList.remove('hidden');
                    }
                });
                calendar.render();
            }

            // --- Lógica de Vistas y Sesión ---
            function showView(viewToShow) { calendarView.classList.add('hidden'); formView.classList.add('hidden'); if (viewToShow === 'calendar') calendarView.classList.remove('hidden'); else if (viewToShow === 'form') formView.classList.remove('hidden'); }
            function showAppView(token) { loginView.classList.add('hidden'); appView.classList.remove('hidden'); initializeCalendar(token); }
            function handleLogout() { localStorage.removeItem('authToken'); appView.classList.add('hidden'); loginView.classList.remove('hidden'); if (calendar) calendar.destroy(); alert("Sesión cerrada."); }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                loadingEl.classList.remove('hidden');
                try {
                    const response = await fetchWithTimeout('http://localhost:3000/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || 'Error al iniciar sesión');
                    }
                    localStorage.setItem('authToken', data.token);
                    showAppView(data.token);
                } catch (error) {
                    loginError.textContent = error.message;
                } finally {
                    loadingEl.classList.add('hidden');
                }
            });

            newFolioButton.addEventListener('click', () => {
                folioForm.reset();
                selectedFiles = []; renderImagePreviews();
                additionalItems = []; renderAdditionalItems();
                selectedCakeFlavors = []; renderTags(cakeFlavorContainer, selectedCakeFlavors, removeCakeFlavor);
                selectedFillings = []; renderTags(fillingContainer, selectedFillings, removeFilling);
                tiersData = []; tiersTableBody.innerHTML = '';
                checkRestrictions();
                balanceInput.value = '0.00';
                inStorePickupCheckbox.checked = false;
                inStorePickupCheckbox.dispatchEvent(new Event('change'));
                addComplementCheckbox.checked = false;
                addComplementCheckbox.dispatchEvent(new Event('change'));
                googleMapsLocationCheckbox.checked = false;
                googleMapsLocationCheckbox.dispatchEvent(new Event('change'));
                document.getElementById('formTitle').textContent = 'Crear Nuevo Folio';
                folioTypeSelect.dispatchEvent(new Event('change'));
                showView('form');
            });
            
            cancelFormButton.addEventListener('click', () => { showView('calendar'); });

            folioForm.addEventListener('submit', async (e) => {
                e.preventDefault(); loadingEl.classList.remove('hidden');
                const authToken = localStorage.getItem('authToken');
                const formData = new FormData();
                let hour = parseInt(document.getElementById('deliveryHour').value);
                const minute = document.getElementById('deliveryMinute').value, period = document.getElementById('deliveryPeriod').value;
                if (period === 'PM' && hour !== 12) { hour += 12; } if (period === 'AM' && hour === 12) { hour = 0; }
                const deliveryTime = `${hour.toString().padStart(2, '0')}:${minute}:00`;

                let deliveryLocation = '';
                if (inStorePickupCheckbox.checked) {
                    deliveryLocation = 'Recoge en Tienda';
                } else if (googleMapsLocationCheckbox.checked) {
                    deliveryLocation = 'El cliente envía ubicación (Google Maps)';
                } else {
                    const parts = [
                        `${streetInput.value || ''} ${extNumberInput.value || ''}`.trim(),
                        intNumberInput.value ? `Int. ${intNumberInput.value}` : '',
                        neighborhoodInput.value ? `Col. ${neighborhoodInput.value}` : ''                       
                    ];
                    deliveryLocation = parts.filter(Boolean).join(', ');
                }

                formData.append('clientName', document.getElementById('clientName').value);
                formData.append('clientPhone', document.getElementById('clientPhone').value);
                formData.append('deliveryDate', document.getElementById('deliveryDate').value);
                formData.append('deliveryTime', deliveryTime);
                formData.append('folioType', folioTypeSelect.value);
                formData.append('persons', document.getElementById('persons').value);
                formData.append('shape', document.getElementById('shape').value);
                formData.append('designDescription', document.getElementById('designDescription').value);
                formData.append('dedication', document.getElementById('dedication').value);
                formData.append('deliveryLocation', deliveryLocation);
                formData.append('deliveryCost', document.getElementById('deliveryCost').value);
                formData.append('total', document.getElementById('total').value);
                formData.append('advancePayment', document.getElementById('advancePayment').value);
                formData.append('accessories', document.getElementById('accessories').value);
                formData.append('hasExtraHeight', hasExtraHeightCheckbox.checked);
                
                const finalAdditionalItems = additionalItems.map(item => ({ name: `${item.quantity} x ${item.name}`, price: item.totalPrice }));
                formData.append('additional', JSON.stringify(finalAdditionalItems));
                
                formData.append('isPaid', isPaidCheckbox.checked);

                if (folioTypeSelect.value === 'Base/Especial') {
                    const tiers = tiersData.map((tier, index) => {
                        const row = tiersTableBody.children[index];
                        return {
                            persons: row.querySelector('.tier-persons-input').value,
                            panes: tier.panes.join(', '),
                            rellenos: tier.fillings.map(f => f.name).join('; '),
                            notas: row.querySelector('.tier-notes-input').value
                        };
                    });
                    formData.append('tiers', JSON.stringify(tiers));
                } else {
                    formData.append('cakeFlavor', selectedCakeFlavors.join(', '));
                    formData.append('filling', selectedFillings.map(f => f.name).join('; '));
                }
                
                if (addComplementCheckbox.checked) {
                    formData.append('complementPersons', document.getElementById('complementPersons').value);
                    formData.append('complementFlavor', document.getElementById('complementFlavor').value);
                    formData.append('complementFilling', document.getElementById('complementFilling').value);
                    formData.append('complementDescription', document.getElementById('complementDescription').value);
                }
                for (const fileData of selectedFiles) {
                    formData.append('referenceImages', fileData.file);
                    formData.append('imageComments', fileData.comment);
                }

                try {
                    const response = await fetchWithTimeout('http://localhost:3000/api/folios', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: formData });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'Error del servidor'); }
                    alert('¡Folio creado con éxito!'); showView('calendar'); if(calendar) calendar.refetchEvents();
                } catch (error) { alert('Error al crear el folio: ' + error.message); } finally { loadingEl.classList.add('hidden'); }
            });
            
            // --- LÓGICA DE ENTREGA ---
            inStorePickupCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                deliveryAddressSection.classList.toggle('hidden', isChecked);
                if (isChecked) {
                    deliveryCostInput.value = '0';
                    deliveryCostInput.readOnly = true;
                } else {
                    deliveryCostInput.readOnly = false;
                }
                updateTotals();
            });

            googleMapsLocationCheckbox.addEventListener('change', function() {
                addressFields.classList.toggle('disabled-section', this.checked);
            });

            // --- CÁLCULO DE SALDO CORREGIDO ---
            function getGrandTotal() {
                const total = parseFloat(totalInput.value) || 0;
                const delivery = parseFloat(deliveryCostInput.value) || 0;
                const additionalFromList = additionalItems.reduce((sum, item) => sum + item.totalPrice, 0);
                const persons = parseFloat(personsInput.value) || 0;
                
                const normalFillingCost = selectedFillings.reduce((sum, filling) => {
                    if (filling.hasCost && persons > 0) {
                        return sum + ((persons / 20) * 30);
                    }
                    return sum;
                }, 0);

                const tierFillingCost = tiersData.reduce((sum, tier, index) => {
                    if (!tiersTableBody.children[index]) return sum;
                    const row = tiersTableBody.children[index];
                    const tierPersons = parseFloat(row.querySelector('.tier-persons-input').value) || 0;
                    const tierCost = tier.fillings.reduce((tierSum, filling) => {
                        if (filling.hasCost && tierPersons > 0) {
                            return tierSum + ((tierPersons / 20) * 30);
                        }
                        return tierSum;
                    }, 0);
                    return sum + tierCost;
                }, 0);

                return total + delivery + additionalFromList + normalFillingCost + tierFillingCost;
            }

            function calculateBalance() {
                const grandTotal = getGrandTotal();
                const advance = parseFloat(advanceInput.value) || 0;
                balanceInput.value = (grandTotal - advance).toFixed(2);
            }

            function updateTotals() {
                if (isPaidCheckbox.checked) {
                    const grandTotal = getGrandTotal();
                    advanceInput.value = grandTotal.toFixed(2);
                }
                calculateBalance();
            }

            // --- EVENT LISTENERS PARA CUENTAS ---
            [totalInput, deliveryCostInput, personsInput].forEach(input => input.addEventListener('input', updateTotals));
            advanceInput.addEventListener('input', calculateBalance);
            
            isPaidCheckbox.addEventListener('change', function() {
                advanceInput.readOnly = this.checked;
                updateTotals();
            });
            
            tiersTableBody.addEventListener('input', (e) => {
                if (e.target.classList.contains('tier-persons-input')) {
                    updateTotals();
                }
            });


            // --- LÓGICA DE IMÁGENES ---
           function renderImagePreviews() {
                imagePreview.innerHTML = '';
                selectedFiles.forEach((fileData, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'image-preview-wrapper w-full';
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(fileData.file);
                    img.className = 'w-full h-auto object-cover rounded-md border';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-image-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.dataset.index = index;
                    
                    const commentInput = document.createElement('textarea');
                    commentInput.placeholder = 'Añadir un comentario...';
                    commentInput.className = 'w-full text-sm p-2 mt-2 border rounded';
                    commentInput.dataset.index = index;
                    commentInput.value = fileData.comment;

                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    wrapper.appendChild(commentInput);
                    imagePreview.appendChild(wrapper);
                });
            }


            imageInput.addEventListener('change', () => {
                const files = Array.from(imageInput.files);
                if (selectedFiles.length + files.length > 5) {
                    alert('Solo puedes subir un máximo de 5 imágenes.');
                    return;
                }
                 selectedFiles.push(...files.map(file => ({ file, comment: '' })));
                renderImagePreviews();
                imageInput.value = '';
            });

            imagePreview.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-image-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    selectedFiles.splice(index, 1);
                    renderImagePreviews();
                }
            });
            imagePreview.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const index = parseInt(e.target.dataset.index, 10);
                    if (selectedFiles[index]) {
                        selectedFiles[index].comment = e.target.value;
                    }
                }
            });

            // --- LÓGICA DE ADICIONALES ---
            function renderAdditionalItems() {
                additionalList.innerHTML = '';
                additionalItems.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        ${item.quantity} x ${item.name} - $${item.totalPrice.toFixed(2)}
                        <button type="button" class="remove-additional-btn text-red-500 ml-2" data-index="${index}">[x]</button>
                    `;
                    additionalList.appendChild(li);
                });
            }

            addAdditionalButton.addEventListener('click', () => {
                const nameInput = document.getElementById('additionalName');
                const quantityInput = document.getElementById('additionalQuantity');
                const priceInput = document.getElementById('additionalPrice');
                const name = nameInput.value.trim();
                const quantity = parseInt(quantityInput.value, 10);
                const price = parseFloat(priceInput.value);

                if (name && quantity > 0 && !isNaN(price)) {
                    additionalItems.push({ name, quantity, price, totalPrice: quantity * price });
                    renderAdditionalItems();
                    updateTotals();
                    nameInput.value = '';
                    quantityInput.value = '1';
                    priceInput.value = '';
                } else {
                    alert('Por favor, completa la descripción, cantidad y precio del adicional.');
                }
            });

            additionalList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-additional-btn')) {
                    additionalItems.splice(e.target.dataset.index, 1);
                    renderAdditionalItems();
                    updateTotals();
                }
            });

            // --- LÓGICA DE PISOS (TIERS) ---
            function addTierRow() {
                const index = tiersData.length;
                tiersData.push({ panes: [], fillings: [] });

                const row = document.createElement('tr');
                row.className = 'tier-row border-b';
                row.setAttribute('data-index', index);
                row.innerHTML = `
                    <td class="p-2"><input type="number" class="tier-persons-input bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Personas"></td>
                    <td class="p-2">
                        <div class="tag-container panes-container"></div>
                        <button type="button" class="add-tier-pane-btn mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Pan</button>
                    </td>
                    <td class="p-2">
                        <div class="tag-container fillings-container"></div>
                        <button type="button" class="add-tier-filling-btn mt-1 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Relleno</button>
                    </td>
                    <td class="p-2"><input type="text" class="tier-notes-input bg-gray-50 border border-gray-300 text-sm rounded-lg block w-full p-2" placeholder="Notas"></td>
                    <td class="p-1 text-center"><button type="button" class="remove-tier-button text-red-500 font-bold px-2 text-lg">X</button></td>
                `;
                tiersTableBody.appendChild(row);
            }

            folioTypeSelect.addEventListener('change', function() {
                const isSpecial = this.value === 'Base/Especial';
                normalFields.classList.toggle('hidden', isSpecial);
                specialFields.classList.toggle('hidden', !isSpecial);
                if (isSpecial && tiersTableBody.children.length === 0) { addTierRow(); }
                if (isSpecial) {
                    selectedCakeFlavors = [];
                    selectedFillings = [];
                    renderTags(cakeFlavorContainer, [], null);
                    renderTags(fillingContainer, [], null);
                } else {
                    tiersData = [];
                    tiersTableBody.innerHTML = '';
                }
                updateTotals();
            });
            addTierButton.addEventListener('click', addTierRow);
            
            tiersTableBody.addEventListener('click', function(e) {
                const target = e.target;
                const row = target.closest('.tier-row');
                if (!row) return;

                currentTierIndex = parseInt(row.dataset.index, 10);

                const addTierPane = (flavor) => {
                    if (tiersData[currentTierIndex].panes.length < 3) {
                        tiersData[currentTierIndex].panes.push(flavor);
                        renderTags(row.querySelector('.panes-container'), tiersData[currentTierIndex].panes, (tagIndex) => removeTierPane(currentTierIndex, tagIndex));
                    }
                };
                const removeTierPane = (tierIndex, tagIndex) => {
                    tiersData[tierIndex].panes.splice(tagIndex, 1);
                    renderTags(tiersTableBody.children[tierIndex].querySelector('.panes-container'), tiersData[tierIndex].panes, (tagIndex) => removeTierPane(tierIndex, tagIndex));
                };

                const addTierFilling = (filling) => {
                    if (tiersData[currentTierIndex].fillings.length < 2) {
                        tiersData[currentTierIndex].fillings.push(filling);
                        renderTags(row.querySelector('.fillings-container'), tiersData[currentTierIndex].fillings, (tagIndex) => removeTierFilling(currentTierIndex, tagIndex));
                        updateTotals();
                    }
                };
                const removeTierFilling = (tierIndex, tagIndex) => {
                    tiersData[tierIndex].fillings.splice(tagIndex, 1);
                    renderTags(tiersTableBody.children[tierIndex].querySelector('.fillings-container'), tiersData[tierIndex].fillings, (tagIndex) => removeTierFilling(tierIndex, tagIndex));
                    updateTotals();
                };

                if (target.classList.contains('add-tier-pane-btn')) {
                    openSelectionModal('Sabor de Pan (Piso)', cakeFlavorsData.tier, tiersData[currentTierIndex].panes, addTierPane, 3);
                } else if (target.classList.contains('add-tier-filling-btn')) {
                    openFillingModal(addTierFilling, tiersData[currentTierIndex].fillings, 2);
                } else if (target.classList.contains('remove-tier-button')) {
                    const indexToRemove = parseInt(row.dataset.index, 10);
                    tiersData.splice(indexToRemove, 1);
                    row.remove();
                    Array.from(tiersTableBody.children).forEach((r, i) => r.setAttribute('data-index', i));
                    updateTotals();
                } else if(target.closest('.tag-remove-btn')) {
                    const tagContainer = target.closest('.tag-container');
                    const tagIndex = parseInt(target.closest('.tag-remove-btn').dataset.index, 10);
                    if (tagContainer.classList.contains('panes-container')) {
                        removeTierPane(currentTierIndex, tagIndex);
                    } else if (tagContainer.classList.contains('fillings-container')) {
                        removeTierFilling(currentTierIndex, tagIndex);
                    }
                }
            });

            addComplementCheckbox.addEventListener('change', function() {
                complementForm.classList.toggle('hidden', !this.checked);
            });
            
            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            logoutButton.addEventListener('click', handleLogout);

            const storedToken = localStorage.getItem('authToken');
            if (storedToken) { showAppView(storedToken); }
        });
    </script>
</body>
</html>